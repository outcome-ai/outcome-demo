<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Outcome AI - Decision Intelligence for Automotive Capital</title>
  <style>
    :root{
      --bg:#1a2230; --bg2:#141b27;
      --text:#eef3fb; --text2:rgba(238,243,251,.92); --muted:rgba(215,224,236,.72);
      --accent:#6aa6ff; --good:#3ee08f; --warn:#ffcf5a; --bad:#ff5a6a;
      --shadow: 0 18px 70px rgba(0,0,0,.45); --shadow2: 0 10px 40px rgba(0,0,0,.30);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -240px, rgba(106,166,255,.20), transparent 60%),
        radial-gradient(900px 500px at 12% 120%, rgba(62,224,143,.12), transparent 55%),
        radial-gradient(900px 500px at 88% 120%, rgba(255,90,106,.10), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
    }
    .top{position:sticky; top:0; z-index:10; backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(20,25,34,.78), rgba(20,25,34,.55));
      border-bottom:1px solid rgba(255,255,255,.08);}
    .top .inner{max-width:1120px;margin:0 auto;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px;}
    .brand{display:flex; align-items:center; gap:12px; min-width:220px;}
    .mark{width:30px; height:30px; border-radius:10px;border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      position:relative; overflow:hidden; box-shadow: var(--shadow2);}
    .mark::after{content:"";position:absolute;inset:-20px;background:
      radial-gradient(18px 18px at 35% 35%, rgba(106,166,255,.58), transparent 60%),
      radial-gradient(20px 20px at 70% 70%, rgba(62,224,143,.34), transparent 62%);
      opacity:.95;transform: rotate(10deg);mix-blend-mode: screen;}
    .brand .name{display:flex; flex-direction:column; gap:2px;}
    .brand .name strong{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--text2);}
    .brand .name span{font-size:12px;color:var(--muted);}
    .topright{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:9px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);font-size:12px;color:var(--text2);white-space:nowrap;cursor:default;}

    /* Pill tones (more visible, still premium) */
    .pill--good{border-color:rgba(62,224,143,.38); background:rgba(62,224,143,.10); color:rgba(238,243,251,.96);}
    .pill--warn{border-color:rgba(255,207,90,.38); background:rgba(255,207,90,.10); color:rgba(238,243,251,.96);}
    .pill--bad{border-color:rgba(255,90,106,.38); background:rgba(255,90,106,.10); color:rgba(238,243,251,.96);}

    /* VIN Intelligence: make Buy Decision + Buy-To obvious */
    .bdHero{display:flex; gap:12px; align-items:stretch; margin-top:10px;}
    .bdScore{min-width:120px; padding:14px 14px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05);
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center}
    .bdScore.good{border-color:rgba(62,224,143,.34); background:rgba(62,224,143,.10);}
    .bdScore.warn{border-color:rgba(255,207,90,.34); background:rgba(255,207,90,.10);}
    .bdScore.bad{border-color:rgba(255,90,106,.34); background:rgba(255,90,106,.10);}
    .bdPct{font-size:26px; font-weight:700; letter-spacing:.2px; line-height:1; color:rgba(238,243,251,.98);}
    .bdLbl{font-size:11px; letter-spacing:.16em; text-transform:uppercase; opacity:.80; margin-top:6px}
    .bdLine{flex:1; padding:12px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04);}
    .bdLine .k{font-size:11px; letter-spacing:.16em; text-transform:uppercase; opacity:.75;}
    .bdLine .v{font-size:26px; font-weight:650; line-height:1.05; margin-top:6px}
    .bdLine .s{font-size:12px; opacity:.72; margin-top:6px}
    .pill.clickable{cursor:pointer}
    .pill.clickable:hover{border-color:rgba(255,255,255,.20); background:rgba(255,255,255,.07)}
    .dot{width:7px;height:7px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.neutral{background:rgba(255,255,255,.28)}
    .vinStatusWrap{display:inline-flex;align-items:center;gap:8px}
    .vinStatusDot{width:9px;height:9px;box-shadow:0 0 0 2px rgba(0,0,0,.18)}
    .wrap{max-width:1120px;margin:0 auto;padding:10px 18px 16px;}
    .hero{margin-top:0;display:flex;flex-direction:column;align-items:center;text-align:center;gap:10px;max-height:520px;}
    .hero h1{margin:0 0 6px 0;font-size:30px;line-height:1.12;font-weight:720;color:var(--text2);}
    .hero p{margin:0;max-width:760px;font-size:13px;color:var(--muted);line-height:1.45;}
    .vinbox{width:min(860px, 100%);margin-top:0;border-radius:22px;border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));box-shadow: var(--shadow);overflow:hidden;}
    .vinrow{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid rgba(255,255,255,.08);background: rgba(255,255,255,.06);}
    .vinlabel{font-size:11px;letter-spacing:.16em;text-transform:uppercase;color:rgba(238,243,251,.72);padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);}
    .vinrow input{flex:1;background: transparent;border:none;outline:none;color:var(--text2);font-family: var(--mono);font-size:15px;letter-spacing:.04em;padding:10px 6px;}
    .vinrow input::placeholder{color:rgba(215,224,236,.62)}
    .dialwrap{display:flex; align-items:center; gap:10px; padding-left:6px;}
    .dial{width:40px; height:40px; border-radius:999px; position:relative; display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.04); box-shadow: 0 10px 24px rgba(0,0,0,.25);}
    .dial svg{position:absolute; inset:0}
    .dial .center{width:26px;height:26px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);
      display:grid; place-items:center;font-size:11px;font-weight:700;letter-spacing:.08em;color:rgba(238,243,251,.90);}
    .dialmeta{display:flex;flex-direction:column;align-items:flex-start;gap:2px;min-width:124px;}
    .dialmeta .l{font-size:10px;letter-spacing:.16em;text-transform:uppercase;color:rgba(238,243,251,.66);}
    .dialmeta .v{font-size:12px;color:rgba(238,243,251,.92);}
    .btnbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;padding:10px;}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;min-height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);color:var(--text2);font-size:13px;cursor:pointer;user-select:none;transition: transform .08s ease, background .12s ease, border-color .12s ease;}
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.22)}
    .btn.primary{background: rgba(106,166,255,.18); border-color: rgba(106,166,255,.36);} .btn.primary:hover{background:rgba(106,166,255,.22)}
    .ico{width:18px;height:18px;border-radius:7px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.18);background: rgba(255,255,255,.06);font-size:11px;color:rgba(238,243,251,.90);}
    .below{width:min(1040px, 100%);margin:8px auto 0;display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;}
    /* Data Readiness row: single full-width tile above the 3 secondary tiles */
    .belowReadiness{grid-template-columns:1fr; margin:10px auto 0;}
    .drWrap{display:flex; align-items:center; justify-content:space-between; gap:14px;}
    .drLeft{display:flex; flex-direction:column; gap:6px;}
    .drTitle{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.74);}
    .drPct{font-size:26px;font-weight:780;color:var(--text2);letter-spacing:.02em;}
    .drCopy{font-size:12px;color:rgba(215,224,236,.78);line-height:1.35;max-width:520px;}
    .drRing{width:64px;height:64px;border-radius:999px;display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background: conic-gradient(var(--drColor, rgba(255,207,90,.92)) calc(var(--drP, 63) * 1%), rgba(255,255,255,.10) 0);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .drRingInner{width:48px;height:48px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.18);
      display:grid;place-items:center;font-size:12px;font-weight:900;font-family:var(--mono);color:rgba(238,243,251,.92);
    }
    @media (max-width: 980px){ .below{grid-template-columns:1fr;} .hero h1{margin:0 0 6px 0;font-size:30px;line-height:1.12;font-weight:720;color:var(--text2);} .dialmeta{display:none} }
    .tile{border-radius:18px;border:1px solid rgba(255,255,255,.12);background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:14px;box-shadow: var(--shadow2);cursor:pointer;transition: transform .08s ease, border-color .12s ease, background .12s ease;min-height:98px;position:relative;overflow:hidden;}
    .tile:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18); background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.035));}
    .chip{position:absolute; top:12px; right:12px;font-size:11px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);color:rgba(238,243,251,.88);}
    .chip.good{border-color:rgba(62,224,143,.34); background:rgba(62,224,143,.12)}
    .chip.warn{border-color:rgba(255,207,90,.34); background:rgba(255,207,90,.12)}
    .chip.bad{border-color:rgba(255,90,106,.34); background:rgba(255,90,106,.12)}
    .tile .t{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.74);}
    .tile .v{margin-top:10px;font-size:22px;font-weight:760;color:var(--text2);letter-spacing:.02em;}
    .tile .m{margin-top:6px;font-size:12px;color:rgba(215,224,236,.78);line-height:1.35;}
    .hintline{margin-top:0px;font-size:12px;color:rgba(215,224,236,.78);}
    .hintline code{font-family:var(--mono);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06);color:rgba(238,243,251,.90);}
    .modal{position:fixed; inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50;}
    .modal.open{display:flex}
    /*
      Modal scrolling
      - Keep the header fixed
      - Allow the modal body to scroll when content exceeds viewport
      (Fixes the Governance modal appearing "locked" with no scroll.)
    */
    .sheet{width:min(1040px, 100%);border-radius:22px;border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(26,33,48,.96), rgba(22,28,40,.92));box-shadow: 0 30px 90px rgba(0,0,0,.60);
      overflow:hidden; max-height: calc(100vh - 44px); display:flex; flex-direction:column;}
    .shd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.04);}
    .hwrap{display:flex;align-items:flex-start;gap:10px;}
    .back{display:none;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background: rgba(255,255,255,.06);color: rgba(238,243,251,.92);cursor:pointer;font-size:13px;min-width:76px;}
    .back.show{display:inline-flex; align-items:center; gap:8px;}
    .shd .h{display:flex;flex-direction:column;gap:3px;}
    .shd .h strong{font-size:13px;letter-spacing:.14em;text-transform:uppercase;}
    .shd .h span{font-size:12px;color:rgba(215,224,236,.84);font-family:var(--mono)}
    .close{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background: rgba(255,255,255,.06);color: rgba(238,243,251,.92);cursor:pointer;font-size:13px;}
    .sbd{padding:16px;display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;
      overflow:auto; flex:1; min-height:0;}
    @media (max-width: 980px){
      .sbd{grid-template-columns:1fr}
    }

    /* Single-pane layout for segment-first modals (hide right panel, stretch coverage) */
    .sheet.singlePane .sbd{ grid-template-columns: 1fr; }
    .sheet.singlePane .sbd > .panel:nth-child(2){ display:none; }
    .sheet.singlePane .sbd > .panel:nth-child(2){ display:none; }
}
    .panel{border:1px solid rgba(255,255,255,.12);border-radius:18px;background: rgba(255,255,255,.04);padding:14px;}
    .ph{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .ph .t{font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.74);}
    .badge{font-size:11px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background: rgba(255,255,255,.04);color:rgba(238,243,251,.90);white-space:nowrap;}
    .badge.good{border-color:rgba(62,224,143,.34); background:rgba(62,224,143,.12)}
    .badge.warn{border-color:rgba(255,207,90,.34); background:rgba(255,207,90,.12)}
    .badge.bad{border-color:rgba(255,90,106,.34); background:rgba(255,90,106,.12)}

    /* Mini percent chip inside the Buy Decision confidence pill */
    .pctMini{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
      font-weight: 900;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.92);
    }

    /* Buy Decision (vetted layout) */
    .bdGrid{display:grid;grid-template-columns: 1.2fr 1fr;gap:12px;}
    @media (max-width: 980px){ .bdGrid{grid-template-columns:1fr} }
    .bdPanel{border:1px solid rgba(255,255,255,.12);border-radius:18px;background: rgba(0,0,0,.18);padding:12px;}
    .bdHead{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .bdLabel{font-weight:950;letter-spacing:.14em;text-transform:uppercase;font-size:12px;color:rgba(238,243,251,.86);}
    .bdPill{padding:10px 12px;}
    .bdHint{margin:8px 0 10px;color:rgba(215,224,236,.78);font-size:12px;line-height:1.45;}
    .bdCards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0 10px;}
    @media (max-width: 980px){ .bdCards{grid-template-columns:1fr} }
    .bdCard{border:1px solid rgba(255,255,255,.10);border-radius:16px;background: rgba(255,255,255,.03);padding:12px;}
    .bdCardTitle{font-weight:950;letter-spacing:.02em;color:rgba(238,243,251,.92);}
    .bdCardSub{margin-top:4px;color:rgba(215,224,236,.80);font-size:12px;line-height:1.35;}
    .bdCardMono{margin-top:4px;font-family:var(--mono);font-variant-numeric:tabular-nums;color:rgba(238,243,251,.92);font-size:14px;}
    .bdBars{display:flex;flex-direction:column;gap:10px;margin:10px 0 12px;}
    .bdBarRow{display:grid;grid-template-columns: 260px 1fr 56px;gap:10px;align-items:center;}
    @media (max-width: 720px){ .bdBarRow{grid-template-columns:1fr} }
    .bdBarName{font-size:12px;color:rgba(215,224,236,.84);font-weight:950;}
    .bdTrack{height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.22);overflow:hidden;}
    .bdFill{height:100%;border-radius:999px;background: rgba(106,166,255,.92);}
    .bdPct{text-align:right;font-size:12px;color:rgba(238,243,251,.90);font-family:var(--mono);}
    .bdCallout{border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.18);border-radius:16px;padding:12px;}
    .bdCallTitle{font-weight:950;margin-bottom:6px;color:rgba(238,243,251,.92)}
    .bdBullets{margin:0;padding-left:18px;color:rgba(215,224,236,.80);font-size:12px;line-height:1.55;}
    .bdBullets li{margin:4px 0;}
    .bdFooter{margin-top:12px;color:rgba(215,224,236,.78);font-size:12px;line-height:1.45;}
    .bdTwo{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width: 980px){ .bdTwo{grid-template-columns:1fr} }
    .bdStat{margin-top:6px;color:rgba(215,224,236,.80);font-size:12px;line-height:1.35;}
    .bdTiny{margin-top:6px;color:rgba(215,224,236,.55);font-size:12px;line-height:1.35;}
    .bdDivider{height:1px;background:rgba(255,255,255,.08);margin:12px 0;}
    .kv{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:10px;}
    @media (max-width:520px){ .kv{grid-template-columns:1fr} }
    .k{border:1px solid rgba(255,255,255,.10);border-radius:14px;background: rgba(255,255,255,.04);padding:10px;}
    .k .l{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.66);}
    .k .v{margin-top:6px;font-size:16px;font-weight:760;color:rgba(238,243,251,.95);}
    .k .s{margin-top:6px;font-size:12px;color:rgba(215,224,236,.80);line-height:1.35;}
    .muted{color:rgba(215,224,236,.82)}
    .table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;}
    .table th,.table td{padding:10px;font-size:12px;border-bottom:1px solid rgba(255,255,255,.07);}
    .table th{text-align:left;font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.72);background: rgba(255,255,255,.05);}
    .table tr:last-child td{border-bottom:none}
    .foot{margin-top:10px;font-size:12px;color:rgba(215,224,236,.82);line-height:1.55;}
    .chiprow{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:12px;}
    @media (max-width: 980px){.chiprow{grid-template-columns:repeat(2,minmax(0,1fr));}}
    @media (max-width: 520px){.chiprow{grid-template-columns:1fr;}}
    .qchip{display:flex;flex-direction:column;gap:6px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);min-width:0;}
    .qchip .qlabel{font-size:10px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.70);} 
    .qchip .qval{font-weight:900;color:rgba(238,243,251,.92);font-size:13px;line-height:1.15;white-space:normal;overflow-wrap:anywhere;}
    .qchip.good{border-color:rgba(62,224,143,.34); background:rgba(62,224,143,.10)}
    .qchip.warn{border-color:rgba(255,207,90,.34); background:rgba(255,207,90,.10)}
    .qchip.bad{border-color:rgba(255,90,106,.34); background:rgba(255,90,106,.10)}
    .help{display:none;margin-top:0px;text-align:center;font-size:12px;color:rgba(215,224,236,.66);}
    .help kbd{font-family:var(--mono);font-size:11px;padding:3px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.04);color:rgba(238,243,251,.88);}

    .rightCoI{margin-top:2px;}
    .rightCoI .coiHdr{font-size:12px;font-weight:950;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.86);} 
    .rightCoI .coiSub{margin-top:6px;color:rgba(215,224,236,.80);font-size:12px;line-height:1.45;}
    .rightCoI .coiList{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
    .rightCoI .coiLi{font-size:12px;color:rgba(215,224,236,.82);line-height:1.45;}
    .sheet.small{width:min(520px,100%);}
    .field{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .field label{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.70)}
    .field input, .field textarea{border-radius:14px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.05);color: rgba(238,243,251,.92);
      font-family: var(--mono);font-size:14px;padding:10px 12px;outline:none;}
    .field textarea{min-height:92px;resize:vertical;}
    .row{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;}
    .minihelp{font-size:12px;color:rgba(215,224,236,.78);line-height:1.5;margin-top:10px;}
  
    /* Buy Decision — Should We Really Buy This Car? (kept intentionally minimal to avoid clutter) */
    .govGrid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px;}
    @media (max-width: 980px){.govGrid{grid-template-columns:1fr}}
    .govStack{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .govRow{display:grid;grid-template-columns: 160px 1fr 56px;gap:10px;align-items:center;}
    .govLabel{font-size:12px;color:rgba(215,224,236,.82);font-weight:700;}
    .govTrack{height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.04);overflow:hidden;}
    .govFill{height:100%;border-radius:999px;background: rgba(106,166,255,.92);}
    .govPct{text-align:right;font-family:var(--mono);font-size:12px;color:rgba(238,243,251,.90);}
    .miniList{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
    .miniItem{border:1px solid rgba(255,255,255,.10);border-radius:14px;background: rgba(255,255,255,.04);padding:10px;}
    .miniItem .top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;position:static;backdrop-filter:none;background:none;border:none;}
    .miniItem .name{font-size:12px;font-weight:760;color:rgba(238,243,251,.92);letter-spacing:.02em;}
    .miniItem .meta{margin-top:6px;font-size:12px;color:rgba(215,224,236,.80);line-height:1.4;}
    .govHint{margin-top:10px;font-size:12px;color:rgba(215,224,236,.78);line-height:1.55;}
    .toggleLink{font-size:12px;color:rgba(170,196,255,.92);cursor:pointer;user-select:none;}
    .toggleLink:hover{opacity:.9;text-decoration:underline;}

    /* Insights ticker */
    .insightsWrap{
      width:min(1040px, 100%);
      margin:12px auto 0;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .insHead{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .insHead .l{
      display:flex; align-items:center; gap:10px;
      font-size:12px; letter-spacing:.14em; text-transform:uppercase;
      color:rgba(238,243,251,.78);
    }
    .insHead .r{
      font-size:12px; color:rgba(215,224,236,.80);
    }
    .ticker{
      position:relative;
      overflow:hidden;
      padding:10px 12px 12px;
    }
    .track{
      display:flex; gap:10px;
      width:max-content;
      animation: scroll 56s linear infinite;
      will-change: transform;
    }
    .insightsWrap:hover .track{ animation-play-state: paused; }
    @keyframes scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .ipill{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:rgba(238,243,251,.90);
      white-space:nowrap;
      cursor:pointer;
    }
    .itag{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      color:rgba(238,243,251,.70);
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    .itag.good{border-color:rgba(62,224,143,.34); background:rgba(62,224,143,.10)}
    .itag.warn{border-color:rgba(255,207,90,.34); background:rgba(255,207,90,.10)}
    .itag.bad{border-color:rgba(255,90,106,.34); background:rgba(255,90,106,.10)}

    

    /* Segment cards (Acquire / Stop) */
    .segCard{
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .segTop{display:flex; justify-content:space-between; gap:12px; align-items:flex-start;}
    .segTitle{font-size:13px; color:rgba(238,243,251,.92); line-height:1.2;}
    .segMeta{font-size:12px; color:rgba(215,224,236,.82); font-family: var(--mono); margin-top:3px;}
    .segWhy{font-size:12px; color:rgba(215,224,236,.78); margin-top:6px;}
    .proofStrip{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;}
    .proofStrip .itag{padding:3px 7px;} /* match Top Insights tags */
    .proofStripHdr{
      display:flex; flex-wrap:wrap; gap:8px;
      margin:10px 0 12px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background: rgba(255,255,255,.025);
    }
/* Utility */
    .hidden{display:none !important;}

  
    .govSummaryLine{margin:10px 0 14px; padding:10px 12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(255,255,255,.03); font-size:12px; color:rgba(255,255,255,.82); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .govSummaryLine .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .govSummaryLine .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); font-weight:800;}
    .govSummaryLine .pill .dot{width:8px; height:8px; border-radius:99px; background:var(--warn);}
    .govSummaryLine .pill.good .dot{background:var(--good);}
    .govSummaryLine .pill.bad .dot{background:var(--bad);}
    .govSummaryLine a{color:rgba(255,255,255,.92); text-decoration:none; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04); padding:7px 10px; border-radius:12px; font-weight:800;}
    .govSummaryLine a:hover{background:rgba(255,255,255,.07);}


.heroLogo{
  width:64px;
  height:64px;
  object-fit:contain;
  display:block;
  image-rendering: -webkit-optimize-contrast;
}

/* ================================
   Outcome Logo — HERO (50x emphasis)
   ================================ */
.heroLogoWrap{margin:-18px auto -12px;display:grid;place-items:center;
  }

.heroLogo{
  width: 360px;              /* BIG */
  height: 360px;
  object-fit:contain;
  display:block;
  image-rendering: -webkit-optimize-contrast;
}

.hero{gap:6px; max-height:none;}
.heroLogoWrap{margin:-10px auto 2px !important;}
.hero h1{margin-top:0 !important;}
.vinbox{margin-top:-2px !important;}
.below{margin:6px auto 0 !important;}
.insightsWrap{margin-top:6px !important;}


/* === Above-the-fold tune (move VIN + tiles up, preserve 3-col tiles) === */
.hero{gap:10px;}
.heroLogoWrap{margin:-26px auto -6px !important;}
.hero h1{margin:0 0 6px 0;}
.hero p{margin:0;}
.vinbox{margin-top:-10px !important;}
.below{margin-top:10px;}
.insightsWrap{margin-top:10px !important;}


/* ================================
   Premium spacing tune (above-the-fold)
   Goal: restore breathing room without reintroducing deadspace
   ================================ */
.wrap{ padding: 12px 18px 18px !important; }

/* Hero rhythm */
.hero{ gap: 14px !important; margin-top: 0 !important; }
.heroLogoWrap{ margin: 0 auto 14px !important; }
.hero h1{ margin: 0 0 10px 0 !important; }
.hero p{ margin: 0 0 8px 0 !important; line-height: 1.5 !important; }

/* VIN module */
.vinbox{ margin-top: 6px !important; }
.vinrow{ padding: 14px !important; }
.btnbar{ padding: 12px !important; }

/* Tiles + insights spacing */
.below{ margin: 16px auto 0 !important; }
.grid3{ gap: 14px !important; }
.tiles{ gap: 14px !important; }
.section{ margin-top: 14px !important; }

/* ================================
   Responsive + fold-safe hero (14" laptops + smaller)
   Key: scale logo by viewport height, not fixed px
   ================================ */
:root{
  --logoWrap: clamp(150px, 22vh, 260px);
  --logoImg:  clamp(130px, 20vh, 230px);
  --heroGap:  clamp(10px, 2vh, 16px);
}

/* Keep hero content-driven, not full-screen */
.hero{
  gap: var(--heroGap) !important;
  margin-top: 0 !important;
  max-height: none !important;
}

/* Responsive logo (no more 420px fixed box) */
.heroLogoWrap{
  width: var(--logoWrap) !important;
  height: var(--logoWrap) !important;
  margin: 0 auto 8px !important;
}
.heroLogo{
  width: var(--logoImg) !important;
  height: var(--logoImg) !important;
}

/* Fold-safe typography */
.hero h1{
  font-size: clamp(22px, 2.5vw, 30px) !important;
  line-height: 1.12 !important;
  margin: 0 0 8px 0 !important;
}
.hero p{
  font-size: clamp(12px, 1.35vw, 14px) !important;
  line-height: 1.45 !important;
  margin: 0 0 6px 0 !important;
}

/* Fold-safe spacing across sections */
.wrap{ padding: 10px 18px 14px !important; }
.vinbox{ margin-top: 4px !important; }
.below{ margin-top: 12px !important; }
.grid3{ gap: 12px !important; }

/* Short viewport (common on 14" MacBook with browser chrome): tighten further */
@media (max-height: 820px){
  :root{
    --logoWrap: clamp(130px, 18vh, 210px);
    --logoImg:  clamp(115px, 16vh, 190px);
    --heroGap:  10px;
  }
  .vinrow{ padding: 12px !important; }
  .btnbar{ padding: 10px !important; }
  .section{ margin-top: 12px !important; }
}

/* Very short viewport: keep everything above fold */
@media (max-height: 740px){
  :root{
    --logoWrap: 150px;
    --logoImg:  135px;
  }
  .hero h1{ font-size: 22px !important; }
  .hero p{ display:none !important; } /* drop subhead only when needed */
  .below{ margin-top: 10px !important; }
}

/* ================================
   Foreground logo (LOCKED) — zero layout shift
   Keep existing heroLogoWrap for spacing, but hide its image.
   ================================ */
.hero{ position: relative !important; }

/* Preserve spacing but prevent duplicate mark */
.heroLogoWrap .heroLogo{ opacity: 0 !important; }

/* Foreground mark sits above content without affecting flow */
.heroLogoForeground{
  position:absolute;
  left:50%;
  top:6px;                 /* close to header */
  transform:translateX(-50%);
  width:clamp(180px, 18vw, 260px);
  height:auto;
  z-index:4;
  pointer-events:none;
}

/* Premium COI panel (used inside Outcome Memory right side) */
.rightCoI .coiHdr{
  font-weight:950; letter-spacing:.16em; text-transform:uppercase;
  color: rgba(238,243,251,.78); font-size:12px;
  margin-bottom:6px;
}
.rightCoI .coiSub{ color: rgba(238,243,251,.62); font-size:13px; margin-bottom:12px; }
.rightCoI .coiBig{
  border:1px solid rgba(255,207,90,.24);
  background: rgba(255,207,90,.10);
  border-radius:16px;
  padding:12px 12px;
  display:flex; align-items:baseline; justify-content:space-between; gap:10px;
  margin-bottom:12px;
}
.rightCoI .coiLabel{ font-size:12px; font-weight:900; color: rgba(255,244,210,.92); letter-spacing:.06em; }
.rightCoI .coiVal{ font-size:18px; font-weight:950; color: rgba(255,244,210,.98); }
.rightCoI .coiList{ display:flex; flex-direction:column; gap:8px; }
.rightCoI .coiLi{ color: rgba(238,243,251,.85); font-weight:800; font-size:13px; }

  
/* --- COI Directional Preview (premium, consistent) --- */
.coiPanel{display:flex;flex-direction:column;gap:12px;}
.coiCard{
  border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border-radius:18px;
  padding:14px 14px 12px;
  box-shadow: 0 14px 50px rgba(0,0,0,.28);
}
.coiTopRow{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
.coiTopLeft{min-width:0;}
.coiKicker{font-size:12px;font-weight:950;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.86);}
.coiMeta{margin-top:6px;color:rgba(215,224,236,.76);font-size:13px;line-height:1.35;}
.coiPill{
  display:inline-flex;align-items:center;gap:8px;
  padding:7px 12px;border-radius:999px;
  border:1px solid rgba(255,206,120,.45);
  background:rgba(255,206,120,.10);
  color:rgba(255,244,210,.95);
  font-weight:900;font-size:12px;
  white-space:nowrap;
}
.coiMidRow{margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.coiAction{display:flex;align-items:center;gap:10px;min-width:0;}
.coiDot{width:10px;height:10px;border-radius:999px;flex:0 0 auto;background:rgba(120,255,189,.95);}
.coiDot.bad{background:rgba(255,102,120,.95);}
.coiDot.warn{background:rgba(255,210,95,.95);}
.coiActionText{font-weight:950;font-size:18px;color:rgba(238,243,251,.98);white-space:nowrap;}
.coiMeaning{color:rgba(215,224,236,.70);font-size:14px;font-weight:800;}
.coiBody{margin-top:10px;}
.coiLead{font-size:16px;font-weight:950;color:rgba(238,243,251,.98);line-height:1.25;}
.coiLead .money{color:rgba(255,244,210,.98);}
.coiSubline{margin-top:8px;color:rgba(215,224,236,.72);font-size:14px;line-height:1.35;}
.coiGrid{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;}
.coiCell .lbl{font-size:12px;font-weight:950;letter-spacing:.12em;text-transform:uppercase;color:rgba(215,224,236,.55);}
.coiCell .val{margin-top:6px;font-size:16px;font-weight:950;color:rgba(238,243,251,.95);line-height:1.1;}
.coiRule{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:10px 12px;
  color:rgba(215,224,236,.76);
  font-size:13px;
  line-height:1.35;
}
.coiRule strong{color:rgba(238,243,251,.95);}
.sourcePanel{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  border-radius:18px;
  padding:12px;
}
.sourceHdr{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;}
.sourceTitle{font-size:12px;font-weight:950;letter-spacing:.14em;text-transform:uppercase;color:rgba(238,243,251,.86);}
.sourceGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;}
.sourceCell{
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  border-radius:14px;
  padding:10px 12px;
}
.sourceCell .k{font-size:12px;font-weight:950;letter-spacing:.12em;text-transform:uppercase;color:rgba(215,224,236,.55);}
.sourceCell .v{margin-top:6px;font-size:18px;font-weight:950;color:rgba(238,243,251,.95);line-height:1.05;}
.sourceCell .v.emph{color:rgba(225,255,241,.95);}


/* --- COI Store Modal helpers (premium, matches Outcome Memory) --- */
.pill--coi{border-color:rgba(255,206,92,.42)!important;background:rgba(255,206,92,.14)!important;color:rgba(255,244,215,.95)!important}
.divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
.coiCard{border-radius:18px;padding:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
.coiInsight{margin-top:0;color:rgba(238,243,251,.92);font-weight:900;font-size:14px;line-height:1.3}
.coiMuted{margin-top:6px;color:rgba(215,224,236,.72);font-size:13px;line-height:1.35}
.coiMetaGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
.meta{border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
.metaK{font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:rgba(238,243,251,.55);font-weight:900}
.metaV{margin-top:6px;color:rgba(238,243,251,.92);font-weight:900;font-size:14px;line-height:1.15}


    /* ===== VIN SUPER MODAL (Premium) ===== */
    .omodal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.58);z-index:9999}
    .omodal[aria-hidden="false"]{display:flex}
    .omodal__sheet{width:min(1200px,94vw);max-height:90vh;overflow:auto;border-radius:22px;
      background:linear-gradient(180deg, rgba(36,47,65,.96), rgba(24,32,46,.96));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 30px 90px rgba(0,0,0,.55);
    }
    .omodal__top{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:inherit;backdrop-filter: blur(10px);z-index:1}
    .omodal__title{flex:1;min-width:0}
    .kicker{font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(238,243,251,.65);font-weight:900}
    .headline{margin-top:4px;font-size:14px;color:rgba(238,243,251,.92);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dotSep{opacity:.55;margin:0 8px}
    .btn--ghost{border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.03);color:rgba(238,243,251,.92);font-weight:800}

    .superGrid{display:grid;grid-template-columns: 1.15fr 1fr 1fr;gap:14px;padding:14px}
    @media (max-width: 1050px){ .superGrid{grid-template-columns:1fr; } }

    .pane{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:14px}
    .pane__hdr{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .pane__label{font-size:12px;letter-spacing:.22em;text-transform:uppercase;color:rgba(238,243,251,.65);font-weight:900}

    .chipGrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:10px 0 12px}
    .chip{border-radius:16px;padding:10px 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);min-height:54px}
    .chip__k{font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:rgba(238,243,251,.55);font-weight:900}
    .chip__v{margin-top:6px;font-size:13px;color:rgba(238,243,251,.92);font-weight:900;line-height:1.15}

    .statGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
    .stat{border-radius:16px;padding:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
    .stat__k{font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:rgba(238,243,251,.55);font-weight:900}
    .stat__v{margin-top:6px;font-size:20px;font-weight:900;color:rgba(238,243,251,.95)}
    .stat__s{margin-top:6px;color:rgba(215,224,236,.70);font-size:12.5px;line-height:1.35}

    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .srcGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .srcCard{border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
    .srcK{font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:rgba(238,243,251,.55);font-weight:900}
    .srcV{margin-top:6px;color:rgba(238,243,251,.92);font-weight:900;font-size:14px;line-height:1.15}

    .coiCard{border-radius:18px;padding:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
    .coiInsight{margin-top:10px;color:rgba(238,243,251,.92);font-weight:900;font-size:14px;line-height:1.3}
    .coiMuted{margin-top:6px;color:rgba(215,224,236,.72);font-size:13px;line-height:1.35}
    .coiMetaGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
    .meta{border-radius:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03)}
    .metaK{font-size:11px;letter-spacing:.18em;text-transform:uppercase;color:rgba(238,243,251,.55);font-weight:900}
    .metaV{margin-top:6px;color:rgba(238,243,251,.92);font-weight:900;font-size:14px;line-height:1.15}


    .pill--bad{border-color:rgba(255,90,106,.35);background:rgba(255,90,106,.12)}

/* =========================
   iOS / Premium Polish Layer
   ========================= */
:root{
  --ink: rgba(238,243,251,.92);
  --ink2: rgba(238,243,251,.72);
  --ink3: rgba(238,243,251,.56);
  --glass: rgba(255,255,255,.045);
  --glass2: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.10);
  --stroke2: rgba(255,255,255,.13);
  --shadowA: 0 24px 80px rgba(0,0,0,.55);
  --shadowB: 0 10px 30px rgba(0,0,0,.28);
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",
    system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* Modal */
.omodal__sheet{
  width:min(1320px,96vw)!important;
  border-radius:26px!important;
  border:1px solid var(--stroke)!important;
  box-shadow:var(--shadowA)!important;
}

/* Headers */
.kicker,.pane__label,.ph .t{
  font-size:11px!important;
  letter-spacing:.22em!important;
  color:var(--ink3)!important;
  font-weight:800!important;
}
.headline{
  font-size:14px!important;
  color:var(--ink)!important;
  font-weight:650!important;
}

/* Panels */
.pane,.panel{
  border-radius:20px!important;
  border:1px solid rgba(255,255,255,.09)!important;
  background:linear-gradient(180deg,var(--glass2),rgba(255,255,255,.03))!important;
  box-shadow:var(--shadowB)!important;
  padding:16px!important;
}
.muted{
  color:var(--ink2)!important;
  font-size:13px!important;
  line-height:1.45!important;
}

/* Pills */
.pill,.badge{
  padding:7px 10px!important;
  font-size:12px!important;
  font-weight:800!important;
  border-radius:999px!important;
  background:rgba(255,255,255,.045)!important;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Chips */
.chip{
  border-radius:18px!important;
  padding:10px 12px!important;
}
.chip__k{
  font-size:10.5px!important;
  color:var(--ink3)!important;
}
.chip__v{
  font-size:13px!important;
  font-weight:750!important;
  color:var(--ink)!important;
}

/* Stats */
.stat__v{
  font-size:18px!important;
  font-weight:800!important;
}
.stat__s{
  font-size:12.5px!important;
}

/* COI */
.coiInsight{
  font-size:13.5px!important;
  font-weight:750!important;
}
.coiMuted{
  font-size:12.8px!important;
}
.metaK{font-size:10.5px!important;}
.metaV{font-size:13px!important;}


/* === COI Store Modal — iOS Premium Override (match Super Modal look) === */
#coiStoreModal.modal{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.58);
  z-index:9999;
}
#coiStoreModal.modal[aria-hidden="false"]{display:flex}
#coiStoreModal .sheet{
  width:min(1200px,94vw);
  max-height:90vh;
  overflow:auto;
  border-radius:22px;
  background:linear-gradient(180deg, rgba(36,47,65,.96), rgba(24,32,46,.96));
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 30px 90px rgba(0,0,0,.55);
}
#coiStoreModal .modalTop{
  display:flex; align-items:center; gap:12px;
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  position:sticky; top:0;
  background:inherit;
  backdrop-filter: blur(10px);
  z-index:1;
}
#coiStoreModal .modalTitle{flex:1; min-width:0}
#coiStoreModal .sub{
  margin-top:4px;
  color:rgba(215,224,236,.72);
  font-size:13px;
  line-height:1.35;
}
#coiStoreModal .btnGhost{
  border-radius:14px;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.03);
  color:rgba(238,243,251,.92);
  font-weight:800;
}
#coiStoreModal .modalBody.twoCol{
  display:grid;
  grid-template-columns: 1.15fr 1fr;
  gap:14px;
  padding:14px;
}
@media (max-width: 1050px){
  #coiStoreModal .modalBody.twoCol{grid-template-columns:1fr}
}
#coiStoreModal .panel{
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  padding:14px;
}
#coiStoreModal .panelHdr{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
#coiStoreModal .panelLabel,
#coiStoreModal .sectionTitle{
  font-size:12px;
  letter-spacing:.22em;
  text-transform:uppercase;
  color:rgba(238,243,251,.65);
  font-weight:900;
}
#coiStoreModal .panel p,
#coiStoreModal .panel .muted,
#coiStoreModal .panel .subtle,
#coiStoreModal .panel .rowNote{
  color:rgba(215,224,236,.72);
  font-size:13px;
  line-height:1.35;
}
#coiStoreModal .bigQuote{
  color:rgba(238,243,251,.92);
  font-weight:900;
  font-size:14px;
  line-height:1.3;
}
#coiStoreModal .divider{
  height:1px;
  background:rgba(255,255,255,.10);
  margin:12px 0;
}
#coiStoreModal .card,
#coiStoreModal .stackCard{
  border-radius:16px;
  padding:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
}
#coiStoreModal .actionSteps{
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  padding:12px;
}


/* === iOS Premium micro-pass (spacing + motion) === */
.omodal__top{padding:12px 14px !important; gap:10px !important;}
.omodal__sheet{will-change:opacity,transform; transform:translateY(6px); opacity:0;
  transition:opacity .18s ease, transform .18s ease;
}
.omodal[aria-hidden="false"] .omodal__sheet{opacity:1; transform:translateY(0);}
@media (prefers-reduced-motion: reduce){
  .omodal__sheet{transition:none !important; transform:none !important; opacity:1 !important;}
}
.superGrid{gap:12px !important; padding:12px !important;}
.pane{padding:12px !important;}
.pane__hdr{margin-bottom:8px !important;}
.chipGrid{gap:8px !important; margin:8px 0 10px !important;}
.statGrid{gap:8px !important; margin-top:8px !important;}
.divider{margin:10px 0 !important;}
/* Slightly tighter card paddings inside long right column */
.coiCard{padding:12px !important;}
.meta{padding:10px 12px !important;}
/* Buttons */
.btn--primary{
  border-radius:14px; padding:10px 12px;
  border:1px solid rgba(106,166,255,.40);
  background:rgba(106,166,255,.14);
  color:rgba(238,243,251,.95);
  font-weight:900;
}
.btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}


/* ===== Micro-pass: tighter vertical rhythm + modal entry animation ===== */
:root{
  --pad-1:12px;
  --pad-2:14px;
  --gap-1:10px;
  --gap-2:12px;
}

/* Global rhythm trims (2–4px) */
.modal .sheet{ padding: var(--pad-2); }
.modal .sheet .panel{ padding: var(--pad-2); }
.modal .sheet .panelHdr{ margin-bottom: 10px; }
.modal .sheet .divider{ margin: 10px 0; }
.modal .sheet .coiCard{ padding: 12px; }
.modal .sheet .statGrid{ margin-top: 8px; gap: 10px; }
.modal .sheet .chipGrid{ gap: 10px; margin: 10px 0 10px; }
.modal .sheet .stat{ padding: 12px; }
.modal .sheet .muted{ line-height: 1.35; }

/* Supermodal rhythm trims */
.omodal__top{ padding: 12px 14px; }
.superGrid{ gap: 12px; padding: 12px; }
.pane{ padding: 12px; }
.pane__hdr{ margin-bottom: 8px; }
.divider{ margin: 10px 0; }

/* Action buttons (COI modal) */
.actionRow{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 10px; }
.actionBtn{
  border-radius: 14px;
  padding: 10px 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.05);
  color: rgba(238,243,251,.92);
  font-weight: 900;
  font-size: 13px;
  cursor: pointer;
}
.actionBtn:hover{ background: rgba(255,255,255,.075); }
.actionBtn--primary{
  border-color: rgba(106,166,255,.35);
  background: rgba(106,166,255,.12);
}
.actionBtn--warn{
  border-color: rgba(255,207,90,.35);
  background: rgba(255,207,90,.12);
}

/* Subtle modal entry animation (opacity + translateY(6px)) */
@keyframes modalIn{
  from{ opacity:0; transform: translateY(6px) scale(.995); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}
.modal.open .sheet{
  animation: modalIn .16s ease-out both;
}
.omodal[aria-hidden="false"] .omodal__sheet{
  animation: modalIn .16s ease-out both;
}



/* ==========================================================
   Outcome System Layer — iOS Premium Tokens (v19)
   Goal: global polish without touching modal wiring
   ========================================================== */
:root{
  /* Type */
  --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
    Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  --w-regular: 450;
  --w-medium: 560;
  --w-semibold: 650;
  --w-bold: 720;

  /* Radii */
  --r-10: 10px;
  --r-14: 14px;
  --r-18: 18px;
  --r-22: 22px;
  --r-26: 26px;
  --r-pill: 999px;

  /* Strokes (default 1px, upgrade to hairline on retina) */
  --stroke: rgba(255,255,255,.10);
  --stroke-2: rgba(255,255,255,.14);
  --stroke-3: rgba(255,255,255,.18);

  /* Glass */
  --glass-1: rgba(255,255,255,.045);
  --glass-2: rgba(255,255,255,.06);

  /* Shadows */
  --sh-card: 0 10px 34px rgba(0,0,0,.28);
  --sh-modal: 0 30px 90px rgba(0,0,0,.60);

  /* Motion */
  --ease-ui: cubic-bezier(.2,.8,.2,1);
  --ease-modal: cubic-bezier(.2,.9,.2,1);
  --dur-ui: 180ms;
  --dur-modal: 300ms;

  /* Touch */
  --tap-h: 44px;
}

body{
  font-family: var(--font-sans) !important;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: geometricPrecision;
}

/* Consistent hierarchy */
.hero h1{font-weight: var(--w-bold) !important;}
.brand .name strong{font-weight: var(--w-semibold) !important;}
.brand .name span{font-weight: var(--w-medium) !important;}
.tile .t,.drTitle,.vinlabel,.kicker,.pane__label,.ph .t,.table th,.itag,.bdLabel,.bdBarName,.govLabel{
  font-weight: var(--w-semibold) !important;
}
.tile .v,.drPct,.stat__v,.k .v,.coiLead,.coiActionText{
  font-weight: var(--w-bold) !important;
}

/* Shared surfaces */
.vinbox,.tile,.insightsWrap,.sheet,.omodal__sheet,.panel,.pane,.bdPanel,.bdCard,.bdCallout,.sourcePanel,.miniItem,.qchip,.k,.stat,.srcCard,.coiCard,.meta,.sourceCell,.govSummaryLine{
  border: 1px solid var(--stroke) !important;
  box-shadow: var(--sh-card) !important;
}

/* Hairline upgrade on retina */
@media (min-resolution: 2dppx){
  .vinbox,.tile,.insightsWrap,.sheet,.omodal__sheet,.panel,.pane,.bdPanel,.bdCard,.bdCallout,.sourcePanel,.miniItem,.qchip,.k,.stat,.srcCard,.coiCard,.meta,.sourceCell,.govSummaryLine,
  .pill,.badge,.btn,.ipill,.close,.back,.btn--ghost,.btnGhost,.actionBtn{
    border-width: .5px !important;
    border-color: var(--stroke-2) !important;
  }
}

/* Pills + chips */
.pill,.badge,.itag,.ipill,.chip{
  border-radius: var(--r-pill) !important;
}
.pill,.badge,.ipill{
  background: var(--glass-1) !important;
}
.pill.clickable,.ipill{
  transition: background var(--dur-ui) var(--ease-ui), border-color var(--dur-ui) var(--ease-ui), transform 120ms var(--ease-ui);
}
.pill.clickable:hover,.ipill:hover{
  background: var(--glass-2) !important;
  border-color: var(--stroke-3) !important;
  transform: translateY(-1px);
}

/* Buttons — iOS tap targets + motion */
.btn,.close,.back,.btn--ghost,.btnGhost,.actionBtn{
  min-height: var(--tap-h) !important;
  transition: transform 120ms var(--ease-ui), background var(--dur-ui) var(--ease-ui), border-color var(--dur-ui) var(--ease-ui), box-shadow var(--dur-ui) var(--ease-ui);
}
.btn:hover,.close:hover,.back:hover,.btn--ghost:hover,.btnGhost:hover,.actionBtn:hover{
  transform: translateY(-1px);
  border-color: var(--stroke-3) !important;
}
.btn:active,.close:active,.back:active,.btn--ghost:active,.btnGhost:active,.actionBtn:active{
  transform: translateY(0px) scale(.99);
}

/* Tiles — smoother premium hover */
.tile{
  transition: transform 120ms var(--ease-ui), border-color var(--dur-ui) var(--ease-ui), background var(--dur-ui) var(--ease-ui), box-shadow var(--dur-ui) var(--ease-ui) !important;
}
.tile:hover{
  box-shadow: 0 14px 44px rgba(0,0,0,.34) !important;
}

/* Modal entry (applies to both classic modal + supermodal) */
@keyframes outcomeModalIn{
  from{ opacity:0; transform: translateY(8px) scale(.995); }
  to{ opacity:1; transform: translateY(0) scale(1); }
}
.modal.open .sheet{
  animation: outcomeModalIn var(--dur-modal) var(--ease-modal) both;
  box-shadow: var(--sh-modal) !important;
}
.omodal[aria-hidden="false"] .omodal__sheet{
  animation: outcomeModalIn var(--dur-modal) var(--ease-modal) both;
  box-shadow: var(--sh-modal) !important;
}
@media (prefers-reduced-motion: reduce){
  .modal.open .sheet,
  .omodal[aria-hidden="false"] .omodal__sheet{ animation:none !important; }
}

/* Modal headers: crisp + consistent */
.shd,.omodal__top,#coiStoreModal .modalTop{
  border-bottom: 1px solid rgba(255,255,255,.08) !important;
}
.shd .h strong,.omodal__title .headline,#coiStoreModal .modalTitle .headline{
  font-weight: var(--w-semibold) !important;
}

/* Spacing ladder (light touch) */
.top .inner{padding: 10px 18px !important;}
.vinrow{padding: 14px !important;}
.btnbar{padding: 12px !important;}
.below{gap: 14px !important;}
.sbd{gap: 14px !important;}
.superGrid{gap: 14px !important;}



/* ==========================================================
   v19.4 — Tile corner chips match Insights pills (smaller + opacity locked)
   Safe: CSS-only, scoped to tiles so supermodal .chip cards remain unchanged
   ========================================================== */
:root{
  --tile-pill-opacity: .74; /* LOCKED */
  --tile-pill-h: 22px;
  --tile-pill-pad-x: 10px;
  --tile-pill-fs: 10.5px;
  --tile-pill-minw: 78px; /* symmetry */
}

/* Scope ONLY to main dashboard tiles */
.tile > .chip{
  position:absolute;
  top:12px; right:12px;

  display:inline-flex;
  align-items:center;
  justify-content:center;

  height: var(--tile-pill-h);
  min-width: var(--tile-pill-minw);
  padding: 0 var(--tile-pill-pad-x);

  border-radius: 999px;
  font-size: var(--tile-pill-fs);
  letter-spacing: .14em;
  text-transform: uppercase;
  font-weight: 800;

  opacity: var(--tile-pill-opacity);

  /* quiet by default */
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
  color: rgba(238,243,251,.74);

  white-space: nowrap;
}

/* Color language (matches Insights itag.*) */
.tile > .chip.good{
  border-color: rgba(62,224,143,.34);
  background: rgba(62,224,143,.10);
  color: rgba(225,255,241,.90);
}
.tile > .chip.warn{
  border-color: rgba(255,207,90,.34);
  background: rgba(255,207,90,.10);
  color: rgba(255,244,210,.92);
}
.tile > .chip.bad{
  border-color: rgba(255,90,106,.34);
  background: rgba(255,90,106,.10);
  color: rgba(255,220,225,.92);
}

/* Keep hover subtle; no visual dominance */
.tile:hover > .chip{ opacity: calc(var(--tile-pill-opacity) + .06); }



/* ==========================================================
   v19.6 — Tile chips EXACTLY match Top Insights pill sizing
   Reuse .itag metrics (Recon / Discipline)
   ========================================================== */

/* Inherit sizing from Insights pills */
.tile > .chip{
  height: 20px;
  padding: 0 8px;
  min-width: unset;        /* Insights pills auto-size */
  font-size: 10px;
  letter-spacing: .12em;
  font-weight: 700;
  border-radius: 999px;
  opacity: .74;            /* locked */
}



/* ==========================================================
   v19.7 — Tile chips EXACTLY mirror Top Insights pills (.itag)
   Uses same padding model (3px 8px) instead of fixed height.
   ========================================================== */
.tile > .chip{
  /* match .itag metrics */
  height: auto !important;
  padding: 3px 8px !important;
  min-width: unset !important;
  font-size: 10px !important;
  letter-spacing: .14em !important;
  font-weight: 700 !important;
  line-height: 1 !important;

  opacity: .74 !important; /* locked */
}



/* ==========================================================
   v19.8 — Tile chips reset to EXACT .itag pill (tight to text)
   Goal: pill hugs letters (not big capsule / not circle)
   ========================================================== */
.tile > .chip{
  /* keep positioning */
  position:absolute !important;
  top:12px !important;
  right:12px !important;

  /* match .itag exactly */
  display:inline-block !important;
  width:max-content !important;
  height:auto !important;
  padding:3px 8px !important;

  font-size:10px !important;
  letter-spacing:.14em !important;
  text-transform:uppercase !important;
  font-weight:600 !important;
  line-height:1 !important;

  border-radius:999px !important;
  border:1px solid rgba(255,255,255,.12) !important;
  background: rgba(255,255,255,.03) !important;
  color:rgba(238,243,251,.70) !important;

  opacity:.74 !important; /* locked */
}

/* Keep color language but DO NOT inflate size */
.tile > .chip.good{
  border-color: rgba(62,224,143,.34) !important;
  background: rgba(62,224,143,.10) !important;
  color: rgba(225,255,241,.90) !important;
}
.tile > .chip.warn{
  border-color: rgba(255,207,90,.34) !important;
  background: rgba(255,207,90,.10) !important;
  color: rgba(255,244,210,.92) !important;
}
.tile > .chip.bad{
  border-color: rgba(255,90,106,.34) !important;
  background: rgba(255,90,106,.10) !important;
  color: rgba(255,220,225,.92) !important;
}



/* ==========================================================
   v19.9 — FIX: global .chip min-height was inflating tile chips
   Force tile chips to be true text-hugging pills (like .itag)
   ========================================================== */
.tile > .chip{
  min-height: unset !important;
  min-width: unset !important;
  width: max-content !important;

  height: auto !important;
  padding: 3px 8px !important;

  display: inline-block !important;
  line-height: 1 !important;
}


    /* Strong override: make Buy Decision % match Buy-To size */
    .bdScore .bdPct{font-size:28px !important; font-weight:700 !important;}
    .bdLine .v{font-size:28px !important; font-weight:650 !important;}

    /* Stronger semantic pill colors (used for VIN Confidence + Segment Signal) */
    .pill.pill--good{border-color:rgba(62,224,143,.55) !important; background:rgba(62,224,143,.12) !important; color:rgba(238,243,251,.96) !important;}
    .pill.pill--warn{border-color:rgba(255,207,90,.55) !important; background:rgba(255,207,90,.12) !important; color:rgba(238,243,251,.96) !important;}
    .pill.pill--bad{border-color:rgba(255,90,106,.55) !important; background:rgba(255,90,106,.12) !important; color:rgba(238,243,251,.96) !important;}

    /* Limited Signal banner — match premium system typography */
    .limitedBanner{
      margin: 10px 0 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: .5px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .limitedBanner .itag{align-self:flex-start;}
    .limitedText{
      font-size: 13.5px;
      line-height: 1.35;
      color: rgba(215,224,236,.85);
      letter-spacing: .1px;
    }
    .limitedText b{
      font-weight: 650;
      color: rgba(238,243,251,.96);
    }

    .input{
      background: rgba(255,255,255,.04);
      border: .5px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      color: rgba(238,243,251,.94);
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .input:focus{
      border-color: rgba(106,166,255,.55);
      box-shadow: 0 0 0 3px rgba(106,166,255,.14), inset 0 1px 0 rgba(255,255,255,.06);
    }
    

/* === Dashboard tile layout (action tiles + COI status strip) === */
#tilesRow{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px;}
/* keep existing tile look, just center content for the two action tiles */
#tileAcquire, #tileStop{min-height:118px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:18px 18px 16px;}
#tileAcquire .t, #tileStop .t{margin:0 0 10px 0;letter-spacing:.26em;text-transform:uppercase;}
#tileAcquire .v, #tileStop .v{margin:0;font-size:46px;font-weight:820;line-height:1;color:var(--text);}
#tileAcquire p, #tileStop p{margin:10px 0 0 0;color:var(--muted);max-width:520px;}
#tileAcquire .chip, #tileStop .chip{position:absolute;top:14px;right:14px;}

/* COI becomes a muted, non-clickable status strip */
#tileCOI{grid-column:1 / -1;min-height:72px;display:flex;align-items:center;justify-content:center;gap:18px;padding:18px 22px;text-align:center;cursor:default;pointer-events:none;opacity:.78;}
#tileCOI .t{margin:0;color:rgba(215,224,236,.72);letter-spacing:.26em;text-transform:uppercase;}
#tileCOI .v{margin:0;font-size:44px;font-weight:820;line-height:1;color:rgba(238,243,251,.86);}
#tileCOI .m,#tileCOI .chip{display:none !important;} /* strip is status only */

/* Ensure Top Insights aligns to full dashboard width */
#insightsWrap, .insightsWrap{width:100%;max-width:1240px;margin-left:auto;margin-right:auto;}

</style>
</head>
<body>
  <script>
  const __demoVIN = '1FTEW1EP5MFA12345';

  // Dealer slug support (for /d/<dealer-slug>/ deployments)
  (function(){
    try{
      var parts = location.pathname.split('/').filter(Boolean);
      if(parts[0]==='d' && parts[1]){
        var slug = decodeURIComponent(parts[1]);
        window.DEALER_SLUG = slug;
        // Optional: map known slugs to friendly names
        var map = {
          'outcome-demo':'Rob Sight Ford',
          'demo':'Rob Sight Ford'
        };
        var name = map[slug] || slug
          .replace(/[-_]+/g,' ')
          .replace(/\b\w/g, function(m){ return m.toUpperCase(); });
        var el = document.getElementById('dealerName');
        if(el) el.textContent = name;
      }
    }catch(e){}
  })();
  </script>

  <div class="top">
    <div class="inner">
      <div class="brand">
        <div class="name">
          <strong>Outcome AI</strong>
          <span>Decision Intelligence for Automotive Capital</span>
        </div>
      </div>
      <div class="topright">
        <div class="pill"><span class="dot good"></span> Ready</div>
        <div class="pill clickable" id="grossPill" title="Click to adjust gross goal"><span class="dot warn"></span> Gross Goal: <span id="grossGoalText">$3,000</span></div>
        <div class="pill clickable hidden" id="govPill" title="Buy Decision — Should We Really Buy This Car? (Store Patterns • Money Turn • Confidence)"><span class="dot warn"></span> Buy Decision</div>
        <div class="pill"><span class="dot good"></span> Dealer: <span id="dealerName">Rob Sight Ford</span></div>
        <div class="pill clickable" id="readinessPill" title="Click to view Data Readiness"><span class="dot warn" id="readinessDot"></span> Data: <span class="pctMini" id="readinessPillPct">63%</span> <span id="readinessPillLabel" style="opacity:.78;">Moderate</span></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
  <img class="heroLogoForeground" src="assets/outcome-mark-white.png" alt="Outcome" />


  <div class="heroLogoWrap" aria-label="Outcome mark">
    <img class="heroLogo" src="assets/outcome-mark-white.png" alt="Outcome" />
  </div>

      <h1>Most tools reset every morning. Outcome doesn't.</h1>
      <p> </p>

      <div class="vinbox" role="region" aria-label="VIN analysis panel">
        <div class="vinrow">
          <div class="vinStatusWrap">
            <div class="vinlabel">VIN</div>
            <span id="vinStatusDot" class="dot vinStatusDot neutral" title="" aria-label="VIN status"></span>
          </div>
          <input id="vinInput" type="text" placeholder="Type or paste a VIN…" value="" />

          <div class="dialwrap" aria-label="Memory Confidence">
            <div class="dial" title="Memory Confidence">
              <svg viewBox="0 0 40 40" aria-hidden="true">
                <circle cx="20" cy="20" r="16" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="3"></circle>
                <circle id="dialArc" cx="20" cy="20" r="16" fill="none" stroke="rgba(62,224,143,.90)" stroke-width="3"
                        stroke-linecap="round" stroke-dasharray="100.53" stroke-dashoffset="25.13"
                        transform="rotate(-90 20 20)"></circle>
              </svg>
              <div class="center" id="dialLetter">H</div>
            </div>
            <div class="dialmeta">
              <div class="l">Memory Confidence</div>
              <div class="v" id="dialText">High</div>
            </div>
          </div>
        </div>

        <div class="btnbar">
          <div class="btn primary" id="btnAnalyze" role="button" tabindex="0">
            <span class="ico">A</span> Analyze
          </div>
          <div class="btn" id="btnAssist" role="button" tabindex="0">
            <span class="ico">⎈</span> Acquisition Assist
          </div>
        </div>
      </div>
    </div>

    <div class="below" id="tilesRow" aria-label="Secondary actions">
      <div class="tile" id="tileAcquire">
        <div class="chip good">Action</div>
        <div class="t">Acquire Now</div>
        <div class="v">5</div>
        <div class="m">Best-fit opportunities — click to drill in.</div>
      </div>

      <div class="tile" id="tileStop">
        <div class="chip bad">Risk</div>
        <div class="t">Stop Buying</div>
        <div class="v">3</div>
        <div class="m">Units that require perfect buying discipline.</div>
      </div>

      <div class="tile" id="tileCOI">
        <div class="chip warn">Leakage</div>
        <div class="t">Cost of Inaction</div>
        <div class="v" id="coiTileValue">$8,420</div>
        <div class="m">Profit leakage + the next move.</div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="shd">
        <div class="hwrap">
          <button class="back" id="btnBack">← Back</button>
          <div class="h">
            <strong id="modalTitle">Outcome</strong>
            <span id="modalSub">—</span>
          </div>
        </div>
        <button class="close" id="btnClose">Close</button>
      </div>

      <div class="sbd">
        <div class="panel">
          <div class="ph">
            <div class="t" id="leftTitle">Outcome Memory</div>
            <div class="badge good" id="leftBadge">Memory Confidence: High</div>
          </div>

          <div class="chiprow" id="quickChips"></div>

          <div class="muted" id="leftIntro" style="font-size:12px; line-height:1.6; margin-top:10px;"></div>

          <div id="govSummaryLine" class="govSummaryLine"></div>

          <div class="kv" id="leftKv"></div>
          <div id="leftExtra"></div>
        </div>

        <div class="panel">
          <div class="ph">
            <div class="t" id="rightTitle">Call Intake</div>
            <div class="badge warn" id="rightBadge">—</div>
          </div>

          <div id="rightBody"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="grossModal" aria-hidden="true">
    <div class="sheet small" role="dialog" aria-modal="true">
      <div class="shd">
        <div class="h">
          <strong>Gross Goal</strong>
          <span>Global setting (tightens discipline line)</span>
        </div>
        <button class="close" id="btnGrossClose">Close</button>
      </div>
      <div class="sbd" style="grid-template-columns:1fr;">
        <div class="panel">
          <div class="muted" style="font-size:12px; line-height:1.6;">
            Set the front gross goal you want to hit. If your goal is higher than your history, Outcome tightens the discipline line.
          </div>
          <div class="field">
            <label for="grossInput">Gross Goal (front gross)</label>
            <input id="grossInput" type="number" min="0" step="50" value="3000" />
          </div>
          <div class="row">
            <button class="close" id="btnGrossSave" style="cursor:pointer;">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="roadmap" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" style="width:min(820px,100%);">
      <div class="shd">
        <div class="h">
          <strong>Queued Upgrades</strong>
          <span>Internal only</span>
        </div>
        <button class="close" id="btnRoadClose">Close</button>
      </div>
      <div class="sbd" style="grid-template-columns:1fr;">
        <div class="panel">
          <div class="muted" style="font-size:12px; line-height:1.7;">
            <ul id="roadList" style="margin:0; padding-left:18px;"></ul>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="modal" id="govModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" style="width:min(980px,100%);">
      <div class="shd">
        <div class="hwrap">
          <div class="h">
            <strong>Buy Decision — Should We Really Buy This Car?</strong>
            <span id="govSub">Based on your store’s history + this VIN</span>
          </div>
        </div>
        <button class="close" id="btnGovClose">Close</button>
      </div>

      <div class="sbd" style="grid-template-columns:1fr;">
        <!-- BUY DECISION layout (matches vetted HTML v3) -->
        <div class="bdGrid">
          <!-- Left column -->
          <div class="bdPanel">
            <div class="bdHead">
              <div class="bdLabel">Overall Outcome Decision (this VIN)</div>
              <div id="overallPill" class="badge good bdPill">
                <span class="pctMini" id="overallPct">—%</span>
                <span id="overallText">—</span>
              </div>
            </div>

            <div class="bdHint">This is how strongly Outcome believes this recommendation fits your store’s history + this VIN.</div>

            <div class="bdCards">
              <div class="bdCard">
                <div class="bdCardTitle">VIN</div>
                <div class="bdCardMono" id="vinShort">—</div>
                <div class="bdCardSub" id="ymmt">—</div>
              </div>
              <div class="bdCard">
                <div class="bdCardTitle">Outcome Says</div>
                <div class="bdCardSub" id="outcomeSays">—</div>
                <div class="bdCardSub">Main reason: <b id="reasonText">—</b></div>
              </div>
            </div>

            <div class="bdHint"><b>What’s driving THIS VIN decision</b> — these %’s are not odds. They show where the risk is coming from for this VIN.</div>
            <div class="bdBars" id="bars"></div>

            <div class="bdCallout">
              <div class="bdCallTitle">What Usually Happens Next</div>
              <ul class="bdBullets" id="usuallyNext"></ul>
            </div>

            <div class="bdFooter">Outcome isn’t judging the car — it’s judging how this store usually performs when it buys cars like this.</div>
          </div>

          <!-- Right column -->
          <div class="bdPanel">
            <div class="bdHead">
              <div class="bdLabel">How This VIN’s Segment Moves at Your Store</div>
              <div class="badge" id="storeDomBadge">Store Avg DOM: —</div>
            </div>

            <div class="bdTwo">
              <div class="bdCard">
                <div class="bdCardTitle">This VIN’s Segment</div>
                <div class="bdCardSub" id="segName">—</div>
                <div class="bdStat">Avg sale: <b id="segDom">—</b> days</div>
                <div class="bdStat">Money Turn Speed: <b id="segSpeed">—</b></div>
                <div class="bdTiny">How fast your cash usually comes back</div>
              </div>
              <div class="bdCard">
                <div class="bdCardTitle">Your Store Baseline</div>
                <div class="bdCardSub">All segments (demo)</div>
                <div class="bdStat">Avg sale: <b id="storeDom">—</b> days</div>
                <div class="bdStat" id="weekLine">—</div>
              </div>
            </div>

            <div class="bdDivider"></div>

            <div class="bdHead">
              <div class="bdLabel">Where This Store Usually Gets Hurt (this VIN)</div>
              <div class="badge warn" id="hurtBadge">Risk: —</div>
            </div>

            <div class="bdCallout">
              <div class="bdCallTitle">Why This VIN Is Flagged</div>
              <ul class="bdBullets" id="flagWhy"></ul>
            </div>

            <div class="bdTwo">
              <div class="bdCard">
                <div class="bdCardTitle">Segment Pattern</div>
                <div class="bdCardSub" id="segPatternTitle">—</div>
                <div class="bdStat">Average result: <b id="segAvgGross">—</b></div>
                <div class="bdStat">Sample size: <b id="segSample">—</b></div>
                <div class="bdStat" id="segPlain">—</div>
              </div>
              <div class="bdCard">
                <div class="bdCardTitle">Buying Pattern</div>
                <div class="bdCardSub">What happens when discipline slips</div>
                <div class="bdStat">Margin pressure: <b id="bpMargin">—</b></div>
                <div class="bdStat">Price action: <b id="bpTiming">—</b></div>
                <div class="bdStat" id="bpPlain">—</div>
              </div>
            </div>

            <div class="bdHint" style="margin-top:10px">This VIN matches a pattern that has cost this store money before — regardless of who bought it.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>

    let grossGoal = 3000;
    const CALL_INTAKE = {};

    const SOURCE_DATA = {
      // type: service | service_upcoming | appraisal | market
      // Demo-safe placeholders until dealer feeds are wired.
      "1FTEW1EP5MFA12345": {
        type: "service",
        label: "Service Lane",
        customerLast: "Henderson",
        lastServiceDaysAgo: 47,
        roStatus: "Closed RO",
        roNumber: "RO-184392",
        roCloseDate: "11/22/25",
        serviceType: "Maintenance + Brakes"
      },
      "1FM5K8D86LGA12345": {
        type: "service_upcoming",
        label: "Upcoming Service",
        customerLast: "Martinez",
        nextAppt: "01/26/26 • 8:30 AM",
        roStatus: "Scheduled",
        apptId: "APT-55219",
        serviceType: "Oil + Multi-point"
      },
      "1FMCU0G63LUA12345": {
        type: "appraisal",
        label: "Recent Appraisal",
        customerLast: "Johnson",
        appraisedDaysAgo: 18,
        appraisalId: "APR-10493",
        serviceType: "Trade appraisal"
      }
    };

    function sourceForVin(vin){
      const v=(vin||"").trim().toUpperCase();
      return SOURCE_DATA[v] || { type:"market", label:"Market", note:"No internal source signal found yet." };
    }

    function sourceChip(src){
      const type = (src && src.type) ? String(src.type) : "market";
      const tone = type==="service" ? "good" : (type==="service_upcoming" || type==="appraisal") ? "warn" : "";
      const icon = type==="service" ? "🛠" : type==="service_upcoming" ? "🗓" : type==="appraisal" ? "📝" : "📊";
      return `<div class="badge ${tone}" style="display:inline-flex; align-items:center; gap:8px;">
                <span style="opacity:.95">${icon}</span>
                <span>${escapeHtml(src.label || "Source")}</span>
              </div>`;
    }

    function kvRow(k,v,opts){
      opts=opts||{};
      const emph = opts.emph ? 'color:rgba(225,255,241,.95);' : '';
      const mono = opts.mono ? 'font-family:var(--mono);' : '';
      return `<div class="k"><div class="l">${escapeHtml(k)}</div><div class="v" style="${emph}${mono}">${escapeHtml(v||"—")}</div></div>`;
    }

    
    function renderSourceRightPanel(vin){
      const src = sourceForVin(vin);
      const chip = sourceChip(src);

      const cell = (k,v,opts)=>{
        opts=opts||{};
        const emph = opts.emph ? ' emph' : '';
        const mono = opts.mono ? ' style="font-family:var(--mono); font-size:16px;"' : '';
        return `<div class="sourceCell">
                  <div class="k">${escapeHtml(k)}</div>
                  <div class="v${emph}"${mono}>${escapeHtml(v||"—")}</div>
                </div>`;
      };

      let grid = '';
      let foot = '';

      if(src.type==="service"){
        grid = [
          cell('Customer', src.customerLast),
          cell('Status', src.roStatus),
          cell('Last Service', `Serviced ${src.lastServiceDaysAgo} days ago`, {emph:true}),
          cell('RO #', src.roNumber, {mono:true}),
          cell('RO Close Date', src.roCloseDate),
          cell('Service Type', src.serviceType)
        ].join('');
        foot = `Outcome is surfacing this vehicle because it’s a <strong>high-probability reacquisition</strong>: known customer, known history, known store.`;
      } else if(src.type==="service_upcoming"){
        grid = [
          cell('Customer', src.customerLast),
          cell('Status', src.roStatus),
          cell('Next Appt', src.nextAppt, {emph:true}),
          cell('Appt ID', src.apptId, {mono:true}),
          cell('Service Type', src.serviceType),
          cell('Reacquire Angle', 'Appointment touchpoint')
        ].join('');
        foot = `This is an <strong>in-lane opportunity</strong>. Timing is the advantage — you already have the customer in motion.`;
      } else if(src.type==="appraisal"){
        grid = [
          cell('Customer', src.customerLast),
          cell('Status', 'Not in Inventory'),
          cell('Last Touch', `Appraised ${src.appraisedDaysAgo} days ago`, {emph:true}),
          cell('Appraisal ID', src.appraisalId, {mono:true}),
          cell('Source Type', src.serviceType),
          cell('Reacquire Angle', 'Valuation already known')
        ].join('');
        foot = `Outcome flags this because the store already did the hard part — <strong>the number is known</strong>.`;
      } else {
        grid = [
          cell('Source', src.label || 'Market'),
          cell('Status', 'No internal signal'),
          cell('Note', src.note || 'No internal source signal found yet.'),
          cell('Unlock', 'Add service/appraisal feed'),
          cell('Angle', 'Lane-based sourcing'),
          cell('Confidence', 'Higher over time')
        ].join('');
        foot = `Add a service/appraisal feed to unlock lane-based sourcing and higher-confidence opportunities.`;
      }

      return `
        <div class="sourcePanel">
          <div class="sourceHdr">
            <div class="sourceTitle">Sourcing</div>
            <div>${chip}</div>
          </div>
          <div class="sourceGrid">${grid}</div>
          <div class="foot" style="margin-top:10px;">${foot}</div>
        </div>
      `;
    }


function renderCOIRightPanel(ctx, dollars){
  const mode = String(ctx||window.__memoryContext||'memory').toLowerCase();
  const isAcquire = mode === 'acquire';
  const isStop = mode === 'stop';
  const isStore = mode === 'store';

  const money = dollars || '—';

  if(isStore){
    return `
      <div class="coiPanel">
        <div class="coiCard">
          <div class="coiTopRow">
            <div class="coiTopLeft">
              <div class="coiKicker">COST OF INACTION</div>
              <div class="coiMeta">This Month (Store Total)<br/>Missed buys + bad holds</div>
            </div>
            <div class="coiPill">Cost of Inaction: ${escapeHtml(money)}</div>
          </div>

          <div class="coiMidRow">
            <div class="coiAction">
              <span class="coiDot warn"></span>
              <div class="coiActionText">Here’s the Leak</div>
            </div>
            <div class="coiMeaning">This is the cost of <strong>doing nothing</strong></div>
          </div>

          <div class="coiBody">
            <div class="coiLead">You’re leaking <span class="money">${escapeHtml(money)}</span> this month by ignoring clear actions.</div>
            <div class="coiSubline">Passing on winners + holding losers</div>

            <div class="coiGrid">
              <div class="coiCell"><div class="lbl">Leak Type</div><div class="val">Missed Buys</div></div>
              <div class="coiCell"><div class="lbl">Leak Type</div><div class="val">Bad Holds</div></div>
              <div class="coiCell"><div class="lbl">Decision Fix</div><div class="val">BUY / DON’T BUY</div></div>
              <div class="coiCell"><div class="lbl">Outcome Fix</div><div class="val">Act faster</div></div>
            </div>

            <div class="coiRule">Dealer-simple meaning: “We’re losing money two ways — by passing on good cars and keeping bad ones.”</div>
          </div>
        </div>
      </div>
    `;
  }

  if(isStop){
    return `
      <div class="coiPanel">
        <div class="coiCard">
          <div class="coiTopRow">
            <div class="coiTopLeft">
              <div class="coiKicker">STOP BUYING</div>
            </div>
            <div class="coiPill">Cost of Inaction: ${escapeHtml(money)}</div>
          </div>

          <div class="coiMidRow">
            <div class="coiAction">
              <span class="coiDot bad"></span>
              <div class="coiActionText">Don’t Buy This</div>
            </div>
            <div class="coiMeaning">This is the cost of <strong>buying</strong></div>
          </div>

          <div class="coiBody">
            <div class="coiLead">You lose <span class="money">${escapeHtml(money)}</span> by buying/holding this vehicle if it lands.</div>
            <div class="coiSubline">Aging compression + recon variance + capital drag</div>

            <div class="coiGrid">
              <div class="coiCell"><div class="lbl">COI Direction</div><div class="val">KEEPING / OWNED</div></div>
              <div class="coiCell"><div class="lbl">Primary Driver</div><div class="val">Aging + recon</div></div>
              <div class="coiCell"><div class="lbl">How it shows up</div><div class="val">Price cuts</div></div>
              <div class="coiCell"><div class="lbl">Timing</div><div class="val">14–45 days</div></div>
            </div>

            <div class="coiRule">Dealer-simple meaning: “This car bleeds us every day we keep it.”</div>
          </div>
        </div>
      </div>
    `;
  }

  // Acquire (default)
  return `
    <div class="coiPanel">
      <div class="coiCard">
        <div class="coiTopRow">
          <div class="coiTopLeft">
            <div class="coiKicker">ACQUIRE NOW</div>
          </div>
          <div class="coiPill">Cost of Inaction: ${escapeHtml(money)}</div>
        </div>

        <div class="coiMidRow">
          <div class="coiAction">
            <span class="coiDot"></span>
            <div class="coiActionText">Buy This</div>
          </div>
          <div class="coiMeaning">This is the cost of <strong>passing</strong></div>
        </div>

        <div class="coiBody">
          <div class="coiLead">You lose <span class="money">${escapeHtml(money)}</span> by not buying this vehicle while demand is hot.</div>
          <div class="coiSubline">Missed front gross + missed velocity window + missed share</div>

          <div class="coiGrid">
            <div class="coiCell"><div class="lbl">COI Direction</div><div class="val">NOT BUYING</div></div>
            <div class="coiCell"><div class="lbl">Primary Driver</div><div class="val">Demand window</div></div>
            <div class="coiCell"><div class="lbl">How it shows up</div><div class="val">Missed gross</div></div>
            <div class="coiCell"><div class="lbl">Timing</div><div class="val">7–14 days</div></div>
          </div>

          <div class="coiRule">Dealer-simple meaning: “This was a layup and we passed.”</div>
        </div>
      </div>
    </div>
  `;
}



    const AUCTION_GUARDRAIL = {
      "1FTEW1EP5MFA12345": { status:"Within Guardrail", rationale:"Wholesale constraints are aligned with your discipline line." },
      "1FM5K8D86LGA12345": { status:"Within Guardrail", rationale:"Guardrail is satisfied at the discipline line." },
      "1FMCU0G63LUA12345": { status:"Outside Guardrail", rationale:"Wholesale constraints are tight. This requires perfect intake and a strict line." }
    };
    const PEER_CONTEXT = {
      "1FTEW1EP5MFA12345": { label:"Top Quartile", note:"Stores like you turn this profile faster when bought clean and inside discipline." },
      "1FM5K8D86LGA12345": { label:"Middle", note:"Peers succeed when recon is verified and pricing is disciplined." },
      "1FMCU0G63LUA12345": { label:"Bottom Quartile", note:"Peers struggle unless bought perfectly. Margin buffer is thin." }
    };

    const VIN_DATA = {
      "1FTEW1EP5MFA12345": { ymmt:"2021 Ford F-150 XLT 4x4", rec:"Buy", confidence:"High", buyTo:"$28,300", walkAway:"$29,200", owned:"5 units", front:"$1,850", recon:"$1,340", days:"23",
        loss:"2 of last 5 units required price cuts after Day 20. Avg compression: -$780.", coi:"$3,420", risk:"Low", turn:"Fast", reconVar:"Low" },
      "1FM5K8D86LGA12345": { ymmt:"2020 Ford Explorer XLT AWD", rec:"Caution", confidence:"Medium", buyTo:"$24,900", walkAway:"$25,600", owned:"3 units", front:"$1,120", recon:"$1,780", days:"29",
        loss:"Recon variance is high. 2 of 3 units compressed after Day 18. Avg compression: -$1,140.", coi:"$2,910", risk:"Medium", turn:"Medium", reconVar:"High" },
      "1FMCU0G63LUA12345": { ymmt:"2021 Ford Escape SE", rec:"High Risk Buy", confidence:"Medium", buyTo:"$18,200", walkAway:"$18,900", owned:"6 units", front:"$690", recon:"$1,420", days:"34",
        loss:"Low margin buffer. 4 of 6 units required price cuts after Day 16. Avg compression: -$620.", coi:"$2,305", risk:"High", turn:"Slow", reconVar:"Medium" }

      /* Demo VINs (real checksum-valid) — used for Governance + Analyze/Assist demos */
      ,"3GNAXKEV2NL118902": { ymmt:"2022 Chevrolet Equinox LT", rec:"High Risk Buy", confidence:"Medium", buyTo:"$20,200", walkAway:"$20,900", owned:"4 units", front:"-$150", recon:"$1,050", days:"61",
        loss:"This profile typically needs price action after Day 25. Avg compression: -$900. Common miss: buying above discipline line.", coi:"$3,180", risk:"High", turn:"Slow", reconVar:"Medium" }
      ,"1FTFW1E58MFA10231": { ymmt:"2021 Ford F-150 Lariat 4x4", rec:"Caution", confidence:"Medium", buyTo:"$39,400", walkAway:"$40,300", owned:"3 units", front:"$1,200", recon:"$1,450", days:"38",
        loss:"Turns are decent, but gross compresses if recon drifts. Watch pack + trim premiums.", coi:"$2,760", risk:"Medium", turn:"Medium", reconVar:"Medium" }
      ,"2T3P1RFV3NW224700": { ymmt:"2022 Toyota RAV4 XLE", rec:"Buy", confidence:"High", buyTo:"$26,900", walkAway:"$27,700", owned:"5 units", front:"$1,750", recon:"$650", days:"19",
        loss:"Repeatable win when bought clean. Minimal recon variance. Moves fast inside discipline.", coi:"$1,420", risk:"Low", turn:"Fast", reconVar:"Low" }
      ,"19XFL1H83NE019991": { ymmt:"2022 Honda Civic Touring", rec:"Buy", confidence:"High", buyTo:"$21,900", walkAway:"$22,600", owned:"4 units", front:"$980", recon:"$540", days:"21",
        loss:"Stable performer. Gross holds when pricing is disciplined in the first 10 days.", coi:"$1,180", risk:"Low", turn:"Fast", reconVar:"Low" }
    };

    const ACQUIRE_NOW = [
      { ymmt:"2021 Ford F-150 XLT 4x4", vin:"1FTEW1EP5MFA12345", conf:"High", why:"Best turn + margin profile. Low recon variance.", buyTo:"$28,300" },
      { ymmt:"2020 Ford Explorer XLT AWD", vin:"1FM5K8D86LGA12345", conf:"Medium", why:"Strong demand but recon swings. Stay disciplined.", buyTo:"$24,900" },
      { ymmt:"2019 Ford Edge SEL AWD", vin:"2FMPK4J96KBB12345", conf:"High", why:"Consistent retail curve. Predictable exit.", buyTo:"$20,700" },
      { ymmt:"2022 Ford Ranger XLT", vin:"1FTER4FH9NLD12345", conf:"High", why:"Fast movers when clean. Margin holds.", buyTo:"$27,100" },
      { ymmt:"2021 Ford Escape SE", vin:"1FMCU0G63LUA12345", conf:"Medium", why:"Only works if bought right. Watch recon.", buyTo:"$18,200" }
    ];

    const STOP_BUYING_UNITS = [
      {
        ymmt:"2018 Ford Escape SE",
        vin:"1FMCU0G63LUA12345",
        flag:"High Risk Buy",
        signal:"Recon variance + thin buffer above the line",
        impact:"Average front compresses after Day 21; markdowns compound quickly.",
        guidance:"Only buy under the Exception Line and verify recon scope before committing."
      },
      {
        ymmt:"2020 Ford Explorer XLT",
        vin:"1FM5K8D86LGA12345",
        flag:"High Risk Buy",
        signal:"Aging cliff + repeated price cuts in history",
        impact:"Profit leakage shows up as days-to-turn climbs past 30.",
        guidance:"If you buy it, buy tight and retail fast—otherwise walk."
      },
      {
        ymmt:"2022 Chevrolet Equinox LT",
        vin:"3GNAXKEV2NL118902",
        flag:"High Risk Buy",
        signal:"Discipline required to protect gross goal",
        impact:"Stretching above the line turns a good truck into a thin-margin deal.",
        guidance:"Stay inside the discipline line or counter—Outcome will not recommend stretching."
      }
    ];

    const COI_BREAKDOWN = [
      { vin:"1FM5K8D86LGA12345", ymmt:"2020 Ford Explorer XLT AWD", leakage:"$2,910", why:"Recon variance + slow decisions compress gross.", action:"Verify recon before committing. Hold the discipline line." },
      { vin:"1FMCU0G63LUA12345", ymmt:"2021 Ford Escape SE", leakage:"$2,305", why:"Thin buffer. Price cuts hit fast after Day 16.", action:"Only buy clean and inside line. Avoid stretching." },
      { vin:"1FTEW1EP5MFA12345", ymmt:"2021 Ford F-150 XLT 4x4", leakage:"$3,420", why:"Waiting loses the deal on hot profiles.", action:"Move same-day and lock the line early." }
    ];


    // Top 10 "store insights" (demo-safe now; in real mode these come from dealer's own deal history + recon + days-to-turn)
    
// ============================================================
// Locked decision thresholds + confidence bands (segment-first)
// ============================================================
// IMPORTANT: This is intentionally "system logic" only — no modal wiring touched.
// Output lists are consumed by existing render functions unchanged.

const DECISION_THRESHOLDS = {
  // Segment-first gating (recommendations only when signal is repeatable)
  // These thresholds are intentionally conservative for dealer trust.
  windowMonths: 24,

  // Minimum segment sample to issue ANY recommendation (Acquire/Stop)
  minUnitsForDecision: 5,

  // Confidence bands (used for labels + disclosure)
  minUnitsForHigh: 8,
  minUnitsForMedium: 5,

  // Acquire Now (segment qualifies only if ALL pass)
  acquire: {
    // Compare to store baselines (computed from all VIN_DATA rows)
    minFrontDelta: 750,     // fg_mean >= FG_median + 750
    maxDaysDelta: -7,       // dts_median <= DTS_median - 7
    maxReconDelta: 150,     // recon_median <= Recon_median + 150 (absolute $; demo-safe)
    maxGrossCV: 0.55,       // stable gross pattern
    maxPctOver45: 0.20      // tail-risk guard
  },

  // Stop Buying (segment flags if 2-of-4 triggers hit)
  stop: {
    maxFrontDelta: -500,    // fg_mean <= FG_median - 500  OR <= 250
    maxFrontAbsolute: 250,
    minDaysDelta: 10,       // dts_median >= DTS_median + 10
    minReconDelta: 350,     // recon_median >= Recon_median + 350
    minPctOver60: 0.25,     // aging tail risk
    hardStop: { minFront: 0, minPctOver60: 0.20 }
  }
};

function parseUnits(x){
  const s = String(x||"").toLowerCase();
  const m = s.match(/(\d+)/);
  return m ? Number(m[1]) : 0;
}
function parseDays(x){
  const n = parseMoneySafe(x); // handles "23" etc
  return Number.isFinite(n) ? n : parseUnits(x);
}
function moneyNum(x){
  const n = parseMoneySafe(x);
  return Number.isFinite(n) ? n : 0;
}

function readinessPct(){
  try{
    return (typeof calcReadiness==="function" && typeof __readinessCoverage==="object")
      ? calcReadiness(__readinessCoverage)
      : 70;
  } catch(e){ return 70; }
}

function confidenceBandFor(meta){
  const units = parseUnits(meta.owned);
  const r = readinessPct();
  if(units >= DECISION_THRESHOLDS.minUnitsForHigh && r >= 85) return "High";
  if(units >= DECISION_THRESHOLDS.minUnitsForMedium && r >= 65) return "Medium";
  if(units >= 1) return "Limited";
  return "Limited";
}

function qualifiesAcquire(meta){
  const units = parseUnits(meta.owned);
  if(units < DECISION_THRESHOLDS.minUnitsForDecision) return false;
  if(String(meta.risk||"") === DECISION_THRESHOLDS.acquire.disallowRisk) return false;
  const days = parseDays(meta.days);
  const front = moneyNum(meta.front);
  const recon = moneyNum(meta.recon);
  return (days>0 && days <= DECISION_THRESHOLDS.acquire.maxDays) &&
         (front >= DECISION_THRESHOLDS.acquire.minFront) &&
         (recon > 0 && recon <= DECISION_THRESHOLDS.acquire.maxRecon);
}

function qualifiesStop(meta){
  const units = parseUnits(meta.owned);
  if(units < DECISION_THRESHOLDS.minUnitsForDecision) return false;
  if(String(meta.risk||"") === DECISION_THRESHOLDS.stop.forceRisk) return true;
  const days = parseDays(meta.days);
  const front = moneyNum(meta.front);
  const recon = moneyNum(meta.recon);
  return (days >= DECISION_THRESHOLDS.stop.minDays) ||
         (front > 0 && front <= DECISION_THRESHOLDS.stop.maxFront) ||
         (recon >= DECISION_THRESHOLDS.stop.minRecon);
}

function signalBandForVin(vin){
  const v = String(vin||"").trim().toUpperCase();
  const meta = VIN_DATA[v] || {};
  const units = parseUnits(meta.owned);
  const band = confidenceBandFor(meta);
  const capped = (units < DECISION_THRESHOLDS.minUnitsForMedium) ? "Limited" : band;
  return {
    vin: v,
    band: capped,
    units,
    readiness: readinessPct(),
    meta
  };
}

function limitedSignalBanner(sig){
  const units = sig && sig.units ? sig.units : 0;
  return `
    <div class="limitedBanner">
      <span class="itag warn">Limited Signal</span>
      <div class="limitedText">
        Based on <b>${units || 1}</b> owned unit${(units===1)?'':'s'} in the lookback. Outcome will still show the profile, but confidence is capped until the sample grows.
      </div>
    </div>
  `;
}

function buildWhyAcquire(meta){
  const days = parseDays(meta.days);
  const front = moneyNum(meta.front);
  const recon = moneyNum(meta.recon);
  const parts = [];
  if(days) parts.push(`Turn: ${days}d`);
  if(front) parts.push(`Front: ${fmtMoney(front)}`);
  if(recon) parts.push(`Recon: ${fmtMoney(recon)}`);
  return parts.length ? parts.join(" • ") : (meta.loss || "Strong profile. Stay disciplined and verify recon.");
}

function buildWhyStop(meta){
  const days = parseDays(meta.days);
  const front = moneyNum(meta.front);
  const recon = moneyNum(meta.recon);
  if(String(meta.risk||"")==="High") return "High risk profile — thin buffer and high downside if discipline slips.";
  const parts = [];
  if(days >= DECISION_THRESHOLDS.stop.minDays) parts.push(`Slow turn (${days}d)`);
  if(front && front <= DECISION_THRESHOLDS.stop.maxFront) parts.push(`Weak front (${fmtMoney(front)})`);
  if(recon >= DECISION_THRESHOLDS.stop.minRecon) parts.push(`Recon heavy (${fmtMoney(recon)})`);
  return parts.length ? parts.join(" • ") : (meta.loss || "Drags performance unless bought perfectly.");
}

function buildListsFromVinData(){
  // Segment-first: decide on repeatable patterns; show ONE representative VIN per qualifying segment.
  const vins = Object.keys(VIN_DATA||{});

  const parseNum = (x)=>{
    if(x==null) return NaN;
    if(typeof x === 'number') return x;
    const s=String(x).trim();
    const n=Number(s);
    return Number.isFinite(n) ? n : NaN;
  };

  const median = (arr)=>{
    const a = arr.filter(n=>Number.isFinite(n)).slice().sort((x,y)=>x-y);
    if(!a.length) return NaN;
    const mid = Math.floor(a.length/2);
    return a.length%2 ? a[mid] : (a[mid-1]+a[mid])/2;
  };
  const mean = (arr)=>{
    const a=arr.filter(n=>Number.isFinite(n));
    return a.length ? a.reduce((p,c)=>p+c,0)/a.length : NaN;
  };
  const stdev = (arr)=>{
    const a=arr.filter(n=>Number.isFinite(n));
    if(a.length<2) return NaN;
    const m=mean(a);
    const v=a.reduce((p,c)=>p+Math.pow(c-m,2),0)/(a.length-1);
    return Math.sqrt(v);
  };
  const cv = (arr)=>{
    const m=mean(arr);
    const sd=stdev(arr);
    if(!Number.isFinite(m) || !Number.isFinite(sd) || Math.abs(m)<1) return NaN;
    return sd/Math.abs(m);
  };

  const yearBand = (year)=>{
    if(!Number.isFinite(year)) return "Unknown";
    const base = year - (year % 2);
    return `${base}-${base+1}`;
  };

  const segmentKeyFromMeta = (meta)=>{
    const ymmt = String(meta?.ymmt||"").trim();
    // Expect: "2021 Ford F-150 XLT 4x4"
    const parts = ymmt.split(/\s+/).filter(Boolean);
    const year = Number(parts[0]);
    const make = parts[1] || "Unknown";
    const model = parts[2] || "Model";
    return `${yearBand(year)} ${make} ${model}`.trim();
  };

  // Store baselines (demo-safe): medians across all VIN rows.
  const allFront = [];
  const allDays = [];
  const allRecon = [];
  vins.forEach(v=>{
    const m = VIN_DATA[v]||{};
    const fg = parseMoneySafe(m.front);
    const dts = parseNum(m.days);
    const rc = parseMoneySafe(m.recon);
    if(Number.isFinite(fg)) allFront.push(fg);
    if(Number.isFinite(dts)) allDays.push(dts);
    if(Number.isFinite(rc)) allRecon.push(rc);
  });
  const FG_med = median(allFront);
  const DTS_med = median(allDays);
  const Recon_med = median(allRecon);

  
  // Expose store baselines for proof strips (render-only; no wiring dependency).
  try{
    window.__storeBaselines = { FG_med, DTS_med, Recon_med };
  }catch(e){}
// Group VIN rows into segments.
  const segs = {};
  vins.forEach(v=>{
    const m = VIN_DATA[v]||{};
    const key = segmentKeyFromMeta(m);
    const s = (segs[key] ||= { key, vins: [], ymmt: m.ymmt || getVehicle(v), owned: 0, fronts: [], days: [], recons: [] });
    s.vins.push(v);
    s.ymmt = s.ymmt || m.ymmt || getVehicle(v);

    const owned = parseUnits(m.owned);
    if(Number.isFinite(owned)) s.owned = Math.max(s.owned, owned);

    const fg = parseMoneySafe(m.front);
    const dts = parseNum(m.days);
    const rc = parseMoneySafe(m.recon);
    if(Number.isFinite(fg)) s.fronts.push(fg);
    if(Number.isFinite(dts)) s.days.push(dts);
    if(Number.isFinite(rc)) s.recons.push(rc);
  });

  const acquire = [];
  const stop = [];

  const confBandFromOwned = (owned)=>{
    if(owned >= DECISION_THRESHOLDS.minUnitsForHigh) return "High";
    if(owned >= DECISION_THRESHOLDS.minUnitsForMedium) return "Medium";
    return "Limited";
  };

  const pct = (arr, pred)=>{
    if(!arr.length) return 0;
    const hit = arr.filter(pred).length;
    return hit/arr.length;
  };

  const pickRepresentativeVin = (seg)=>{
    // Prefer a VIN that exists in GOV_HISTORY lists (if any), else first.
    const candidates = seg.vins.slice();
    return candidates[0] || "";
  };

  Object.values(segs).forEach(seg=>{
    const owned = seg.owned || 0;
    const band = confBandFromOwned(owned);

    // Hard gate for recommendations
    if(owned < DECISION_THRESHOLDS.minUnitsForDecision) return;
    if(band === "Limited") return;

    const fg_mean = mean(seg.fronts);
    const fg_cv = cv(seg.fronts);
    const dts_med = median(seg.days);
    const rc_med = median(seg.recons);
    const pctOver45 = pct(seg.days, d=>Number.isFinite(d) && d>45);
    const pctOver60 = pct(seg.days, d=>Number.isFinite(d) && d>60);

    // Acquire: ALL pass
    const a = DECISION_THRESHOLDS.acquire;
    const acquireOk =
      (Number.isFinite(fg_mean) && Number.isFinite(FG_med) && fg_mean >= (FG_med + a.minFrontDelta)) &&
      (Number.isFinite(dts_med) && Number.isFinite(DTS_med) && dts_med <= (DTS_med + a.maxDaysDelta)) &&
      (Number.isFinite(rc_med) && Number.isFinite(Recon_med) && rc_med <= (Recon_med + a.maxReconDelta)) &&
      (!Number.isFinite(fg_cv) || fg_cv <= a.maxGrossCV) &&
      (pctOver45 <= a.maxPctOver45);

    // Stop: 2-of-4 triggers (plus optional hard stop)
    const s = DECISION_THRESHOLDS.stop;
    const t1 = (Number.isFinite(fg_mean) && Number.isFinite(FG_med) && (fg_mean <= (FG_med + s.maxFrontDelta) || fg_mean <= s.maxFrontAbsolute));
    const t2 = (Number.isFinite(dts_med) && Number.isFinite(DTS_med) && dts_med >= (DTS_med + s.minDaysDelta));
    const t3 = (Number.isFinite(rc_med) && Number.isFinite(Recon_med) && rc_med >= (Recon_med + s.minReconDelta));
    const t4 = (pctOver60 >= s.minPctOver60);
    const hardStop = (Number.isFinite(fg_mean) && fg_mean < s.hardStop.minFront && pctOver60 >= s.hardStop.minPctOver60);
    const trigCount = [t1,t2,t3,t4].filter(Boolean).length;
    const stopOk = hardStop || (trigCount >= 2);

    const vin = pickRepresentativeVin(seg);
    const meta = VIN_DATA[vin] || {};

    if(acquireOk){
      const whyBits = [];
      if(Number.isFinite(dts_med) && Number.isFinite(DTS_med)) whyBits.push(`Turns in <b>${Math.round(dts_med)} days</b> (store median ${Math.round(DTS_med)}).`);
      if(Number.isFinite(fg_mean) && Number.isFinite(FG_med)) whyBits.push(`Avg front <b>${fmtMoney(Math.round(fg_mean))}</b> (median ${fmtMoney(Math.round(FG_med))}).`);
      if(Number.isFinite(rc_med) && Number.isFinite(Recon_med)) whyBits.push(`Recon holds at <b>${fmtMoney(Math.round(rc_med))}</b>.`);
      acquire.push({
        ymmt: meta.ymmt || seg.ymmt,
        vin,
        conf: band,
        segment: seg.key,
        segmentLabel: String(seg.key||"").replace(/(\d{4})-(\d{4})/, "$1–$2"),
        owned,
        why: whyBits.slice(0,2).join(" "),
        buyTo: meta.buyTo || "—",
        // Proof metrics (segment-first)
        proof: {
          fg_mean, fg_cv,
          dts_med,
          rc_med,
          pctOver45,
          // Store baselines
          FG_med, DTS_med, Recon_med
        }
      });
    } else if(stopOk){
      const whyBits = [];
      if(t2 && Number.isFinite(dts_med)) whyBits.push(`Median days <b>${Math.round(dts_med)}</b> — capital drags.`);
      if(t1 && Number.isFinite(fg_mean)) whyBits.push(`Front compresses to <b>${fmtMoney(Math.round(fg_mean))}</b>.`);
      if(t3 && Number.isFinite(rc_med)) whyBits.push(`Recon variance risk at <b>${fmtMoney(Math.round(rc_med))}</b>.`);
      if(t4) whyBits.push(`Aging tail: <b>${Math.round(pctOver60*100)}%</b> over 60 days.`);
      stop.push({
        ymmt: meta.ymmt || seg.ymmt,
        vin,
        segment: seg.key,
        segmentLabel: String(seg.key||"").replace(/(\d{4})-(\d{4})/, "$1–$2"),
        owned,
        flag: "High Risk Buy",
        signal: whyBits.slice(0,2).join(" "),
        impact: meta.loss || "Capital drag compounds as age builds.",
        guidance: "If you buy it, buy under your Exception Line, verify recon scope, and price aggressively from Day 1.",
        proof: {
          fg_mean, fg_cv,
          dts_med,
          rc_med,
          pctOver60,
          // Store baselines
          FG_med, DTS_med, Recon_med
        },
        triggers: { t1, t2, t3, t4, hardStop, trigCount }
      });
    }
  });

  // Stable ordering: best confidence first, then alphabetic.
  const ord = (x)=> x.conf==="High"?0 : x.conf==="Medium"?1 : 2;
  acquire.sort((a,b)=> ord(a)-ord(b) || a.ymmt.localeCompare(b.ymmt));
  stop.sort((a,b)=> a.ymmt.localeCompare(b.ymmt));
  return { acquire, stop };
}

const TOP_INSIGHTS = [
      { tag:"Leakage", tone:"warn", text:"Price cuts after Day 18 are compressing gross by ~$1.1k on Explorer profiles.", drill:"COI" },
      { tag:"Speed", tone:"good", text:"Same-day buying decisions protect margin on hot truck profiles (F-150/compact pickups).", drill:"Acquire" },
      { tag:"Recon", tone:"bad",  text:"High recon variance is the #1 reason deals miss front gross on SUVs.", drill:"Assist" },
      { tag:"Discipline", tone:"warn", text:"Stretching above the discipline line turns ‘good cars’ into thin-buffer risk.", drill:"Memory" },
      { tag:"Turn", tone:"good", text:"Your best performers consistently exit < 28 days when bought clean.", drill:"Acquire" },
      { tag:"Margin", tone:"warn", text:"Low buffer vehicles require perfect intake — seller ask + condition notes matter.", drill:"Memory" },
      { tag:"Avoid", tone:"bad",  text:"Stop Buying list is not ‘bad cars’ — it’s where your store leaks profit unless bought perfectly.", drill:"Stop" },
      { tag:"Goal", tone:"warn", text:"Raising Gross Goal tightens the discipline line automatically (protects the $3k target).", drill:"Gross" },
      { tag:"Confidence", tone:"good", text:"High Memory Confidence = repeatable outcomes; low confidence = slow down and intake more.", drill:"Memory" },
      { tag:"Guardrail", tone:"bad",  text:"Outside Guardrail means wholesale constraints are tight — requires strict line + verified recon.", drill:"Memory" }
    ];


    const UPGRADES_BACKLOG = [
      "Auction Guardrail v1 (status only; never show auction values)",
      "Peer Context v1 (high-level benchmarking)",
      "Progressive disclosure to reduce information overload",
      "Roleplay mode: 15-sec call intake script buttons"
    ];

    const modal = document.getElementById('modal');
    const roadmap = document.getElementById('roadmap');
    const grossModal = document.getElementById('grossModal');

    const vinInput = document.getElementById('vinInput');
    const vinStatusDot = document.getElementById('vinStatusDot');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const btnAssist = document.getElementById('btnAssist');

    const btnClose = document.getElementById('btnClose');
    const btnBack = document.getElementById('btnBack');

    const modalTitle = document.getElementById('modalTitle');
    const modalSub = document.getElementById('modalSub');

    const quickChips = document.getElementById('quickChips');

    const leftTitle = document.getElementById('leftTitle');
    const leftBadge = document.getElementById('leftBadge');
    const leftIntro = document.getElementById('leftIntro');
    const leftKv = document.getElementById('leftKv');
    const leftExtra = document.getElementById('leftExtra');

    const rightTitle = document.getElementById('rightTitle');
    const rightBadge = document.getElementById('rightBadge');
    const rightBody = document.getElementById('rightBody');
  // Aliases for legacy helpers (some functions reference these older names)
  const leftBody = leftExtra;
  const modalBody = rightBody;

    const dialArc = document.getElementById('dialArc');
    const dialLetter = document.getElementById('dialLetter');
    const dialText = document.getElementById('dialText');

    const govPill = document.getElementById('govPill');
    const govModal = document.getElementById('govModal');
    const btnGovClose = document.getElementById('btnGovClose');

    // Show Buy Decision only after a valid VIN is entered (keeps dashboard clean).
    function isValidVin(v){
      const s = (v||'').trim().toUpperCase();
      // Standard VIN length is 17; exclude I/O/Q.
      return /^[A-HJ-NPR-Z0-9]{17}$/.test(s);
    }

    function setVinUI(state){
      // state: 'empty' | 'valid' | 'invalid'
      if(!vinStatusDot) return;
      vinStatusDot.classList.remove('good','bad','neutral');
      vinInput.removeAttribute('title');
      vinStatusDot.removeAttribute('title');

      if(state === 'empty'){
        vinStatusDot.classList.add('neutral');
        return;
      }
      if(state === 'invalid'){
        vinStatusDot.classList.add('bad');
        // Tooltip text must be exactly: "Invalid VIN"
        vinInput.setAttribute('title','Invalid VIN');
        vinStatusDot.setAttribute('title','Invalid VIN');
        return;
      }
      // valid
      vinStatusDot.classList.add('good');
    }

    function updateGovPillVisibility(){
      const vin = (isValidVin(window.__activeVin||'') ? String(window.__activeVin).trim().toUpperCase() : (vinInput.value||'').trim().toUpperCase());
      if(!vin){
        setVinUI('empty');
        govPill.classList.add('hidden');
        closeGov();
        return;
      }
      if(isValidVin(vin)){
        setVinUI('valid');
        govPill.classList.remove('hidden');
      } else {
        setVinUI('invalid');
        govPill.classList.add('hidden');
        // If the user clears/invalidates the VIN, hide details as well.
        closeGov();
      }
    }

    // --- Buy Decision — Should We Really Buy This Car? demo model (kept simple; replaces clutter with one modal) ---
    // In production, these are derived from DMS history + Outcome Memory.
    const GOV_HISTORY = [
      { vin:"1FTEW1EP5MFA12345", ymmt:"2021 Ford F-150 XLT 4x4", segment:"Full-Size Truck", buyer:"Jake (UCM)", acq:28300, dom:23, gross:1850 },
      { vin:"1FM5K8D86LGA12345", ymmt:"2020 Ford Explorer XLT AWD", segment:"Midsize SUV", buyer:"Tanya (Buyer)", acq:24900, dom:29, gross:1120 },
      { vin:"1FMCU0G63LUA12345", ymmt:"2021 Ford Escape SE", segment:"Compact SUV", buyer:"Jake (UCM)", acq:18200, dom:34, gross:690 },
      { vin:"WBA13AW05NFM44018", ymmt:"2022 BMW 330i xDrive", segment:"Entry Luxury", buyer:"Jake (UCM)", acq:31500, dom:58, gross:-600 },
      { vin:"3GNAXKEV2NL118902", ymmt:"2022 Chevy Equinox LT", segment:"Compact SUV", buyer:"Jake (UCM)", acq:21200, dom:64, gross:-850 },
      { vin:"5N1AZ2BJ9NC125611", ymmt:"2022 Nissan Murano SL", segment:"Midsize SUV", buyer:"Tanya (Buyer)", acq:24400, dom:72, gross:-1400 },
      { vin:"2T3P1RFV3NW224700", ymmt:"2022 Toyota RAV4 XLE", segment:"Compact SUV", buyer:"Tanya (Buyer)", acq:27300, dom:19, gross:1750 },
      { vin:"19XFL1H83NE019991", ymmt:"2022 Honda Civic Touring", segment:"Compact Car", buyer:"Jake (UCM)", acq:22350, dom:21, gross:980 },
      { vin:"1GKS2GKD3NR137011", ymmt:"2022 GMC Yukon SLT", segment:"Full-Size SUV", buyer:"Tanya (Buyer)", acq:54800, dom:67, gross:-2200 },
      { vin:"1C4PJXDN9NW194330", ymmt:"2022 Jeep Cherokee Limited", segment:"Midsize SUV", buyer:"Tanya (Buyer)", acq:22900, dom:49, gross:250 },
      { vin:"2FMPK4J96KBB12345", ymmt:"2019 Ford Edge SEL AWD", segment:"Midsize SUV", buyer:"Jake (UCM)", acq:20700, dom:27, gross:1350 },
      { vin:"1FTER4FH9NLD12345", ymmt:"2022 Ford Ranger XLT", segment:"Full-Size Truck", buyer:"Tanya (Buyer)", acq:27100, dom:24, gross:1600 }
    ];

    const GOV_CONF = {
      "1FTEW1EP5MFA12345": { velocity:36, pricing:22, reconROI:28, bias:14 },
      "1FM5K8D86LGA12345": { velocity:24, pricing:20, reconROI:30, bias:26 },
      "1FMCU0G63LUA12345": { velocity:20, pricing:18, reconROI:24, bias:38 }
    };

    function fmtMoney(n){
      try { return n.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0}); }
      catch(e){ return '$'+String(n); }
    }

    function govSum(obj){ return Object.values(obj).reduce((a,b)=>a+b,0); }
    function govAvg(arr){ return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

    function computeCvi(rows){
      const storeAvgDom = govAvg(rows.map(r=>r.dom));
      const bySeg = {};
      rows.forEach(r=>{ (bySeg[r.segment] ||= []).push(r.dom); });
      const segments = Object.entries(bySeg).map(([segment, doms])=>{
        const segAvgDom = govAvg(doms);
        return { segment, segAvgDom, cvi: segAvgDom / storeAvgDom };
      }).sort((a,b)=>a.cvi-b.cvi);
      return { storeAvgDom, segments };
    }

    function computeBias(rows){
      const bySeg = {}, byBuyer = {};
      rows.forEach(r=>{ (bySeg[r.segment] ||= []).push(r.gross); (byBuyer[r.buyer] ||= []).push(r.gross); });
      const segScores = Object.entries(bySeg).map(([segment, grosses])=>{
        const losses = grosses.filter(g=>g<0).length;
        return { segment, lossRate: losses/grosses.length, avgGross: govAvg(grosses), count: grosses.length };
      }).sort((a,b)=> (b.lossRate-a.lossRate) || (a.avgGross-b.avgGross));
      const buyerScores = Object.entries(byBuyer).map(([buyer, grosses])=>{
        const losses = grosses.filter(g=>g<0).length;
        return { buyer, lossRate: losses/grosses.length, avgGross: govAvg(grosses), count: grosses.length };
      }).sort((a,b)=> (b.lossRate-a.lossRate) || (a.avgGross-b.avgGross));
      return { segScores, buyerScores };
    }

    // Build a single-line Governance summary for the Analyze (Outcome Memory) view.
    // Dealer language: no acronyms required, but we keep it punchy.
    function buildGovSummaryLine(vin){
      const v=(vin||'').trim().toUpperCase();
      if(!isValidVin(v)) return '';
      const meta = VIN_DATA[v] || {};
      const recRaw = String(meta.rec || '—');
      const rec = recRaw.toLowerCase();
      // Dealer-simple mapping:
      // - Buy => BUY THIS
      // - Caution => BUY TIGHT
      // - High Risk / Stop => DON'T BUY
      let verdictLabel = 'BUY TIGHT';
      let tone = 'warn';
      if(rec.includes('buy') && !rec.includes('risk') && !rec.includes('caution')){ verdictLabel = 'BUY THIS'; tone='good'; }
      if(rec.includes('risk') || rec.includes('stop') || rec.includes('high')){ verdictLabel = 'DON\'T BUY'; tone='bad'; }

      const pct = Math.round(Math.min(100, Math.max(0, overallConfidencePct(meta))));
      const dotCls = tone==='good' ? 'good' : tone==='bad' ? 'bad' : 'warn';

      return `
        <div class="left">
          <span class="pill ${tone}">
            <span class="dot ${dotCls}"></span>
            <span style="letter-spacing:.12em; font-weight:950;">BUY DECISION</span>
            <span style="opacity:.85;">•</span>
            <span style="font-weight:950;">${verdictLabel}</span>
            <span class="pctMini" style="margin-left:6px;">${pct}%</span>
          </span>
          <span style="opacity:.78;">Click to see the store pattern behind this call.</span>
        </div>
        <a href="#" onclick="window.__openGovFor('${v}');return false;" style="font-weight:950;">Open</a>
      `;
    }


    function primaryDriver(conf){
      const labels={velocity:'Market Velocity', pricing:'Pricing Position', reconROI:'Recon ROI', bias:'Bias Risk'};
      const entries = Object.entries(conf).sort((a,b)=>b[1]-a[1]);
      const [k,v]=entries[0]||['velocity',0];
      return { key:k, label: labels[k]||k, value:v };
    }

    function govBadge(pct){
      if(pct>=75) return {text:'High Confidence', cls:'good'};
      if(pct>=55) return {text:'Medium Confidence', cls:'warn'};
      return {text:'Low Confidence', cls:'bad'};
    }

    // Dealer-language bullets for "What Usually Happens Next".
    // In production this should be derived from the dealer's actual deal history
    // for this VIN profile (segment + acquisition behavior + pricing behavior).
    function govNext(meta){
      const bullets = [];
      const loss = (meta && meta.loss) ? String(meta.loss) : '';

      // Try to extract the most meaningful parts from the demo narrative text.
      // Example: "... after Day 25. Avg compression: -$900. Common miss: buying above discipline line."
      const dayMatch = loss.match(/after\s+Day\s+(\d+)/i);
      const compMatch = loss.match(/Avg\s+compression:\s*([-+]?\$?\d[\d,]*)/i);

      if(dayMatch){
        bullets.push(`Price action usually needed after ~${dayMatch[1]} days`);
      }
      if(compMatch){
        // Normalize "$" prefix
        const c = compMatch[1].includes('$') ? compMatch[1] : ('$' + compMatch[1]);
        bullets.push(`Typical margin pressure around ${c}`);
      }
      if(/discipline\s+line/i.test(loss)){
        bullets.push('Common miss: buying above discipline line');
      }

      // Fallbacks if the narrative string isn't present.
      if(bullets.length === 0){
        const risk = (meta && meta.risk) ? String(meta.risk) : '';
        const turn = (meta && meta.turn) ? String(meta.turn) : '';
        const reconVar = (meta && meta.reconVar) ? String(meta.reconVar) : '';

        if(turn.toLowerCase() === 'slow') bullets.push('Expect earlier price action if it does not move quickly.');
        else bullets.push('If it does not move quickly, price action shows up early.');

        if(reconVar.toLowerCase() === 'high') bullets.push('Recon variance can erase margin — verify recon before committing.');
        else bullets.push('Recon stays predictable when intake is clean.');

        if(risk.toLowerCase() === 'high') bullets.push('This is a discipline buy — don’t stretch above your line.');
        else bullets.push('Stay inside your discipline line to protect gross.');
      }

      // Keep it tight.
      return bullets.slice(0,3);
    }

    // Overall confidence is NOT the sum of the driver % bars.
    // It represents how strongly Outcome believes the recommendation fits this store + this VIN (demo logic).
    function overallConfidencePct(meta){
      if(!meta) return 60;
      if(meta.confidencePct!=null) return meta.confidencePct;
      if(meta.risk==='High') return 82;
      if(meta.risk==='Medium') return 68;
      return 60;
    }

    function openGov(){
  const fromActive = (window.__activeVin||"").trim().toUpperCase();
  const fromInput  = (vinInput.value||"").trim().toUpperCase();
  const vin = isValidVin(fromActive) ? fromActive : fromInput;
  if(!isValidVin(vin)) return;
  // Use active VIN; do not write back into the main VIN input.
  window.__activeVin = vin;
  updateGovPillVisibility();
  govModal.classList.add('open');
  govModal.setAttribute('aria-hidden','false');
  renderGov();
}

// Used by Outcome Memory / lists so "Buy Decision" always opens correctly.
window.__openGovFor = (vin)=>{
  const v=(vin||'').trim().toUpperCase();
  if(!isValidVin(v)) return;
  window.__activeVin = v;
  updateGovPillVisibility();
  openGov();
};

    function closeGov(){
      govModal.classList.remove('open');
      govModal.setAttribute('aria-hidden','true');
    }

    function renderGov(){
      const setText = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = (val==null||val==='') ? '—' : String(val); };
      const setHTML = (id, html)=>{ const el=document.getElementById(id); if(el) el.innerHTML = html||''; };
      const shortVin = (v)=> v ? (v.slice(0,8)+'…'+v.slice(-4)) : '—';

      const vin = (isValidVin(window.__activeVin||'') ? String(window.__activeVin).trim().toUpperCase() : (vinInput.value||'').trim().toUpperCase());
      const row = GOV_HISTORY.find(r=>r.vin===vin);
      const meta = VIN_DATA[vin] || {};

      // Basic VIN/vehicle
      setText('vinShort', shortVin(vin));
      setText('ymmt', meta.ymmt || (row && row.ymmt) || 'Vehicle Unknown');
      const rec = meta.rec || '—';
      setText('outcomeSays', rec);

      // Driver contributions (NOT odds)
      const conf = GOV_CONF[vin] || (meta.risk ? (
        meta.risk==='High' ? {velocity:22, pricing:16, reconROI:22, bias:40} :
        meta.risk==='Medium' ? {velocity:26, pricing:20, reconROI:26, bias:28} :
        {velocity:34, pricing:24, reconROI:28, bias:14}
      ) : {velocity:25, pricing:20, reconROI:25, bias:20});

      const driver = primaryDriver(conf);
      setText('reasonText', driver.label);

      // Overall confidence pill (big number inside pill)
      const pct = Math.min(100, Math.max(0, overallConfidencePct(meta)));
      const b = govBadge(pct);
      const pill = document.getElementById('overallPill');
      if(pill) pill.className = `badge ${b.cls} bdPill`;
      setText('overallPct', `${Math.round(pct)}%`);
      setText('overallText', `CONFIDENT — ${String(rec||'—').toUpperCase()}`);

      // Bars
      const barsEl = document.getElementById('bars');
      if(barsEl){
        barsEl.innerHTML='';
        const rows = [
          ['How fast cars like this sell','velocity'],
          ['How tight the margin gets','pricing'],
          ['Whether recon comes back','reconROI'],
          ['How often this store gets hurt here','bias']
        ];
        rows.forEach(([label,key])=>{
          const pctv = conf[key] || 0;
          const rowEl = document.createElement('div');
          rowEl.className = 'bdBarRow';
          rowEl.innerHTML = `
            <div class="bdBarName">${label}</div>
            <div class="bdTrack"><div class="bdFill" style="width:${pctv}%"></div></div>
            <div class="bdPct">${pctv}%</div>
          `;
          barsEl.appendChild(rowEl);
        });
      }

      // What Usually Happens Next
      const next = govNext(meta);
      const ul = document.getElementById('usuallyNext');
      if(ul){
        ul.innerHTML = '';
        next.forEach(t=>{
          const li = document.createElement('li');
          li.textContent = t;
          ul.appendChild(li);
        });
      }

      // Segment movement / money turn (VIN segment vs store baseline)
      const vinRows = GOV_HISTORY;
      const cviAll = computeCvi(vinRows);
      const storeDom = Math.round(cviAll.storeAvgDom || 0);
      const segRec = (row && cviAll.segments) ? cviAll.segments.find(s=>s.segment===row.segment) : null;
      const segName = (row && row.segment) ? row.segment : (meta.segment || '—');
      const segDom = Math.round((segRec && segRec.segAvgDom) ? segRec.segAvgDom : (row ? row.dom : 0));
      const cviVal = (segRec && segRec.cvi) ? segRec.cvi : (storeDom ? (segDom / storeDom) : 1);

      setText('storeDomBadge', `Store Avg DOM: ${storeDom || '—'} days`);
      setText('segName', segName);
      setText('segDom', segDom ? `${segDom}` : '—');
      setText('segSpeed', `${(Math.round(cviVal*100)/100).toFixed(2)}×`);
      setText('storeDom', storeDom ? `${storeDom}` : '—');

      // Explain in plain English (weeks faster/slower)
      let explain = '—';
      if(storeDom && segDom){
        const delta = segDom - storeDom;
        const abs = Math.abs(delta);
        if(delta === 0) explain = 'About average for this store.';
        else if(delta > 0) explain = `About ${Math.max(1, Math.round(abs/7))} week(s) slower than normal.`;
        else explain = `About ${Math.max(1, Math.round(abs/7))} week(s) faster than normal.`;
      }
      setText('weekLine', explain);
      // Hurt / patterns (VIN-specific summary, no people)
      const biasAll = computeBias(GOV_HISTORY);
      let riskWord = 'Low', badgeCls = 'good';
      let segObj = null;
      if(row){
        segObj = (biasAll.segScores||[]).find(s=>s.segment===row.segment) || null;
        const buyerObj = (biasAll.buyerScores||[]).find(b=>b.buyer===row.buyer) || null;
        const segRisk = segObj ? segObj.lossRate : 0;
        const buyerRisk = buyerObj ? buyerObj.lossRate : 0;
        const combined = (segRisk*0.55 + buyerRisk*0.45);
        if(combined>=0.55 || cviVal>1.20){ riskWord='Medium'; badgeCls='warn'; }
        if(combined>=0.65 || cviVal>1.30){ riskWord='High'; badgeCls='bad'; }
      }
      const hurt = document.getElementById('hurtBadge');
      if(hurt){
        hurt.className = `badge ${badgeCls}`;
        hurt.textContent = `RISK: ${riskWord.toUpperCase()}`;
      }

      const flagWhy = document.getElementById('flagWhy');
      if(flagWhy){
        flagWhy.innerHTML = '';
        const bullets = [
          'This VIN sits in a segment where discipline matters most.',
          'When this store misses on price discipline, margin usually compresses.'
        ];
        bullets.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; flagWhy.appendChild(li); });
      }

      // Segment Pattern (this VIN’s segment)
      if(row && segObj){
        const avg = segObj.avgGross;
        const avgTxt = (avg>=0?'+':'-') + '$' + Math.abs(Math.round(avg)).toLocaleString();
        setText('segPatternTitle', `${row.segment} at this store`);
        setText('segAvgGross', avgTxt);
        setText('segSample', `${segObj.count} units`);
        setText('segPlain', segObj.lossRate>=0.33 ? 'This segment is a known pain point if bought wrong.' : 'Generally safe — but sensitive to buying above discipline line.');
      }

      // Buying Pattern summary
      if(row){
        const days = row.avgCompressDay || 25;
        const comp = row.avgCompression || -900;
        setText('bpMargin', `~$${Math.abs(comp).toLocaleString()} compression`);
        setText('bpTiming', `after ~${days} days`);
        setText('bpPlain', 'When discipline slips, the store usually has to cut price to move it.');
      }
    }


    govPill.addEventListener('click', openGov);
    btnGovClose.addEventListener('click', closeGov);
    govModal.addEventListener('click', (e)=>{ if(e.target===govModal) closeGov(); });

    const grossPill = document.getElementById('grossPill');
    const grossGoalText = document.getElementById('grossGoalText');
    const grossInput = document.getElementById('grossInput');
    const btnGrossClose = document.getElementById('btnGrossClose');
    const btnGrossSave = document.getElementById('btnGrossSave');

    const btnRoadClose = document.getElementById('btnRoadClose');
    const coiTileValue = document.getElementById('coiTileValue');

    let viewStack = [];
    let currentView = null;

    let __dialSnapshot = null;
    let __restoreDialOnClose = false;
    let __currentDial = null;


    function showBack(show){ show ? btnBack.classList.add('show') : btnBack.classList.remove('show'); }
    function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }

    

    function wireMemoryRowClicks(){
      document.querySelectorAll('[data-memrow="1"]').forEach(el=>{
        if(el.__wired) return;
        el.__wired = true;
        el.addEventListener('click', ()=>{
          const vin = (el.getAttribute('data-vin')||'').trim();
          const ctx = (el.getAttribute('data-ctx')||'memory').trim();
          if(window.__drillMemory) window.__drillMemory(vin, ctx);
        });
      });
    }
function cleanupMemoryArtifacts(){
      // Outcome Memory injects a governance one-liner under leftIntro; remove it when switching views
      const g = document.getElementById('govSummaryLine');
      if(g) g.remove();
    }

    function closeModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      viewStack=[]; currentView=null; showBack(false);
      cleanupMemoryArtifacts();
      if(vinInput) vinInput.value='';
      window.__activeVin=''; window.__CURRENT_VIN='';
      // Restore dial state if COI temporarily set it
      if(__restoreDialOnClose && __dialSnapshot!==null){
        setDial(__dialSnapshot);
      }
      __restoreDialOnClose = false;
    }
    function navigate(renderFn, args){
      // Always reset sheet layout before switching views (Acquire/Stop may re-enable singlePane).
      try{ modal.querySelector('.sheet')?.classList.remove('singlePane'); }catch(e){}

      // Snapshot dial before opening COI so closing COI doesn't mutate the global gauge
      if(renderFn === renderCOI){
        __dialSnapshot = (dialText && dialText.textContent) ? dialText.textContent : null;
        __restoreDialOnClose = true;
      } else {
        __restoreDialOnClose = false;
      }

      cleanupMemoryArtifacts();
      if(currentView) viewStack.push(currentView);
      currentView = { renderFn, args };
      showBack(viewStack.length>0);

      try{
        renderFn.apply(null, args || []);
      }catch(err){
        console.error("[Outcome] View render failed:", err);

        // Render a visible error card so clicks don't look like 'nothing happens'
        try{
          modalTitle.textContent = "Error";
          modalSub.textContent = "A view failed to render";

          setQuickChips(chip("Fix", "Open Console to see details", "warn"));

          leftTitle.textContent = "What happened";
          leftBadge.textContent = "Script error";
          setBadge(leftBadge, "Bad");
          leftIntro.textContent = "A JavaScript error prevented this panel from loading. This is fixable — the Console will show the exact line.";

          leftKv.innerHTML = kvCard("Next step", "Copy the first red error line", "Paste it back here so we can patch the exact function.");
          leftExtra.innerHTML = "";

          rightTitle.textContent = "Details";
          rightBadge.textContent = "Debug";
          setBadge(rightBadge, "Medium");
          rightBody.innerHTML = `
            <div class="coiCard">
              <div class="coiMuted"><b>Error:</b> ${String(err && err.message ? err.message : err)}</div>
              <div class="divider"></div>
              <div class="coiMuted">Open <b>DevTools → Console</b>. Copy the first red error line (file + line #).</div>
            </div>`;
        }catch(_){}
      }

      openModal();
    }
    function goBack(){
      cleanupMemoryArtifacts();
      const prev = viewStack.pop();
      currentView = prev || null;
      showBack(viewStack.length>0);
      if(prev) prev.renderFn.apply(null, prev.args || []);
    }

    function setBadge(el, level){
      el.classList.remove('good','warn','bad');
      const l = (level||'').toLowerCase();
      if(l.includes('high') || l.includes('within')) el.classList.add('good');
      else if(l.includes('medium')) el.classList.add('warn');
      else el.classList.add('bad');
    }
    function setDial(conf){
      // Apply Data Readiness cap (keeps Outcome honest on Day 1)
      const capped = capConfidenceLabel(conf);
      const c=(capped||"Low").toLowerCase(); const CIRC=100.53;
      let pct=.25, stroke="rgba(255,90,106,.90)", letter="L", text="Low";
      if(c.includes("high")){pct=.78; stroke="rgba(62,224,143,.92)"; letter="H"; text="High";}
      else if(c.includes("medium")){pct=.52; stroke="rgba(255,207,90,.92)"; letter="M"; text="Medium";}
      dialArc.style.stroke=stroke; dialArc.style.strokeDasharray=CIRC; dialArc.style.strokeDashoffset=CIRC*(1-pct);
      dialLetter.textContent=letter; dialText.textContent=text;
      __currentDial = text;
    }
    function kvCard(label,value,sub){return `<div class="k"><div class="l">${label}</div><div class="v">${value}</div><div class="s">${sub||""}</div></div>`;}
    function fmtMoney(n){const v=Math.round(Number(n)||0); return v.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});}
    function parseMoney(s){if(!s) return NaN; return Number(String(s).replace(/[^0-9.-]/g,''));}

    /* =========================
       DATA READINESS ENGINE
       - Dealer sees one number
       - Internal view shows pillar breakdown
       - Readiness caps confidence claims
    ========================= */

    const READINESS_PILLARS = [
      { key: "inventory_vin", name: "Inventory VIN Coverage", weight: 0.20, hint: "Do we know what you actually own?" },
      { key: "recon",         name: "Recon Cost & Timing",   weight: 0.20, hint: "Do we know cost + time to sellable?" },
      { key: "pricing",       name: "Pricing & Market Data", weight: 0.15, hint: "Do we know if it’s priced to move?" },
      { key: "aging",         name: "Aging & Carry Cost",    weight: 0.15, hint: "Do we know what delay costs?" },
      { key: "sales",         name: "Sales Outcomes",        weight: 0.15, hint: "Do we learn from wins and losses?" },
      { key: "source",        name: "Acquisition Source",    weight: 0.10, hint: "Do we know where inventory came from?" },
      { key: "equity",        name: "Internal Equity Signals",weight:0.05, hint: "Can we mine service + owners?" }
    ];

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function readinessBand(pct){
      if(pct <= 49) return { label:"Low",       cls:"bad",  color:"rgba(255,90,106,.92)", max:"Low" };
      if(pct <= 69) return { label:"Moderate",  cls:"warn", color:"rgba(255,207,90,.92)", max:"Medium" };
      if(pct <= 84) return { label:"High",      cls:"good", color:"rgba(106,166,255,.92)", max:"High" };
      return            { label:"Very High", cls:"good", color:"rgba(62,224,143,.92)", max:"High" };
    }

    function calcReadiness(scoresByKey){
      let total = 0;
      READINESS_PILLARS.forEach(p => {
        const s = clamp(Number(scoresByKey[p.key] ?? 0), 0, 100);
        total += s * p.weight;
      });
      return Math.round(total);
    }

    // Demo starter values (replace later with real coverage computed from exports)
    const __readinessCoverage = {
      inventory_vin: 95,
      recon: 40,
      pricing: 70,
      aging: 80,
      sales: 65,
      source: 50,
      equity: 20
    };

    let __readinessPct = 0;
    let __readinessBand = readinessBand(0);
    let __readinessMaxConfidence = "Low"; // Low | Medium | High

    function capConfidenceLabel(conf){
      const rank = (v)=> v==="Low"?0 : v==="Medium"?1 : 2;
      const desired = String(conf||"Low").toLowerCase().includes("high") ? "High" : (String(conf||"").toLowerCase().includes("medium") ? "Medium" : "Low");
      return (rank(desired) > rank(__readinessMaxConfidence)) ? __readinessMaxConfidence : desired;
    }

    function updateReadinessTile(){
      __readinessPct = calcReadiness(__readinessCoverage);
      __readinessBand = readinessBand(__readinessPct);
      __readinessMaxConfidence = __readinessBand.max;

      // Header pill (primary display)
      const pillPct = document.getElementById('readinessPillPct');
      const pillLabel = document.getElementById('readinessPillLabel');
      const pillDot = document.getElementById('readinessDot');
      if(pillPct) pillPct.textContent = `${__readinessPct}%`;
      if(pillLabel) pillLabel.textContent = __readinessBand.label;
      if(pillDot){
        pillDot.classList.remove('good','warn','bad','neutral');
        // Map readiness band -> dot color (simple + intuitive)
        pillDot.classList.add(__readinessPct <= 49 ? 'bad' : (__readinessPct <= 69 ? 'warn' : 'good'));
      }
    }

    function renderReadinessExplain(){
      setQuickChips("");
      modalTitle.textContent="Data Readiness";
      modalSub.textContent="How it works";
      leftTitle.textContent="Simple Explanation";
      leftBadge.textContent=`Readiness: ${__readinessPct}%`; setBadge(leftBadge, __readinessBand.label);
      leftIntro.textContent="";
      leftKv.innerHTML = kvCard("What is it?", "Data Coverage", "How much decision data Outcome AI can see today.") +
                        kvCard("Why it matters", "Accuracy", "More data = tighter recommendations.");
      leftExtra.innerHTML = `
        <div class="foot"><strong>3rd-grade version:</strong></div>
        <div class="foot">Data Readiness shows how much of your dealership’s decision data Outcome AI can see today.</div>
        <div class="foot">The more data we can see, the more accurate and confident the recommendations become.</div>
        <div class="foot" style="margin-top:10px;"><strong>This score is NOT:</strong></div>
        <ul class="bdBullets" style="margin-top:6px;">
          <li>Not a grade on your team</li>
          <li>Not a judgment</li>
          <li>Not saying your data is bad</li>
        </ul>
        <div class="foot">It just shows how connected your systems are.</div>
        <div class="foot" style="margin-top:10px;"><strong>Simple example:</strong> At <strong>60%</strong>, Outcome AI spots obvious problems. At <strong>85%</strong>, it starts catching mistakes before they happen.</div>
        <div class="foot" style="margin-top:10px;"><strong>Bottom line:</strong> Outcome AI doesn’t need perfect data. It needs enough data to protect you from expensive decisions.</div>
      `;

      rightTitle.textContent="How to use";
      rightBadge.textContent="Pre-frame"; setBadge(rightBadge,"High");
      rightBody.innerHTML = `
        <div class="foot">Show the readiness score <strong>before</strong> showing insights. It sets expectations and prevents defensiveness.</div>
        <div class="foot" style="margin-top:10px;">At <strong>${__readinessPct}%</strong>, cap confidence claims at <strong>${__readinessMaxConfidence}</strong>.</div>
        <div class="foot" style="margin-top:10px;">Press <strong>Back</strong> to return to the breakdown.</div>
      `;
    }

    function renderReadinessBreakdown(){
      setQuickChips("");
      modalTitle.textContent="Data Readiness";
      modalSub.textContent="Coverage + what’s missing";

      leftTitle.textContent="Coverage Breakdown";
      leftBadge.textContent=`Readiness: ${__readinessPct}%`; setBadge(leftBadge, __readinessBand.label);
      leftIntro.textContent="";
  const rows = READINESS_PILLARS.map(p=>{
        const s = clamp(Number(__readinessCoverage[p.key] ?? 0), 0, 100);
        return `
          <div style="padding:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; background: rgba(255,255,255,.03);">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div style="display:flex; flex-direction:column; gap:2px;">
                <div style="font-size:13px; color:rgba(238,243,251,.92); font-weight:800;">${p.name}</div>
                <div style="font-size:12px; color:rgba(215,224,236,.78);">${p.hint} • Weight ${(p.weight*100).toFixed(0)}%</div>
              </div>
              <div style="font-family: var(--mono); font-size:13px; font-weight:900; color:rgba(238,243,251,.92);">${s}%</div>
            </div>
            <div style="height:10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22); overflow:hidden; margin-top:10px;">
              <div style="height:100%; width:${s}%; background:${__readinessBand.color}; border-radius:999px;"></div>
            </div>
          </div>
        `;
      }).join("");

      leftKv.innerHTML="";
  leftExtra.innerHTML = `<div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">${rows}</div>`;

      
      // Dealer-facing content only: Coverage + "what data is needed" guidance
      rightTitle.textContent = "Data needed to reach 100%";
      rightBadge.textContent = "Next step";
      setBadge(rightBadge, "Medium");

      // Identify gaps
      const gaps = [];
      READINESS_PILLARS.forEach((p)=>{
        const v = __readinessCoverage[p.key] ?? 0;
        if(v < 100) gaps.push({ key: p.key, name: p.name, v });
      });

const map = {
        equity: { title:"Internal Equity Signals", from:"CRM / desking (equity position, lead source, close rate)", examples:"VinSolutions / DriveCentric / DealerSocket exports" },
        service: { title:"Service History + RO", from:"DMS / service lane (RO history, mileage cadence, customer identity)", examples:"DealerTrack / Reynolds / CDK RO export" },
        inventory: { title:"Inventory + Pricing", from:"Inventory tool (stock list, recon, pricing changes, age)", examples:"vAuto / HomeNet / inventory feed" },
        sales: { title:"Sales & Gross", from:"CRM / DMS (front gross, days-to-turn, deal outcomes)", examples:"Sales history export" },
        market: { title:"Market Velocity", from:"Market data (comps, velocity, price bands)", examples:"vAuto / market feed" }
      };

      function guessBucket(name){
        const n = (name||"").toLowerCase();
        if(n.includes("equity")) return "equity";
        if(n.includes("service") || n.includes("ro")) return "service";
        if(n.includes("inventory") || n.includes("pricing")) return "inventory";
        if(n.includes("sales") || n.includes("gross")) return "sales";
        if(n.includes("market") || n.includes("velocity")) return "market";
        return "sales";
      }

      const uniqueBuckets = [];
      gaps.forEach(g=>{
        const b = guessBucket(g.name);
        if(!uniqueBuckets.includes(b)) uniqueBuckets.push(b);
      });

      const guidance = gaps.length ? `
    <div class=\"kicker\" style=\"margin:0 0 6px\">How it works</div>
    <div class=\"muted\">Outcome’s confidence is capped by missing data. The fastest path to higher confidence is filling the lowest coverage pillars first.</div>
    <div class=\"divider\"></div>
    
        <div class="muted">Outcome is only as confident as the data you give it. Anything below <b>100%</b> reduces certainty and caps recommendations.</div>
        <div class="divider"></div>
        <div class="muted" style="margin-bottom:8px"><b>Missing inputs:</b></div>
        ${uniqueBuckets.map(b=>{
          const d = map[b] || map.sales;
          return `
            <div class="coiCard" style="margin-bottom:10px">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                <div class="kicker" style="margin:0">${d.title}</div>
                <span class="pill pill--warn">${Math.max(0,100 - Math.min(100, Math.round(gaps.filter(x=>guessBucket(x.name)===b).reduce((a,c)=>a+c.v,0)/Math.max(1,gaps.filter(x=>guessBucket(x.name)===b).length))))}% gap</span>
              </div>
              <div class="coiMuted" style="margin-top:6px"><b>From:</b> ${d.from}</div>
              <div class="coiMuted" style="margin-top:6px"><b>Example:</b> ${d.examples}</div>
            </div>
          `;
        }).join("")}
        <div class="coiMuted">Once these feeds are connected (or exported), Coverage hits 100% and Outcome can raise confidence caps.</div>
      ` : `
        <div class="muted">You're at <b>100%</b> coverage. Outcome can score with maximum confidence.</div>
      `;

      rightBody.innerHTML = guidance;
setTimeout(()=>{
        const b = document.getElementById('btnReadinessExplain');
        if(b){
          b.addEventListener('click', ()=>navigate(renderReadinessExplain,[]));
          b.addEventListener('keydown', (e)=>{ if(e.key==='Enter') navigate(renderReadinessExplain,[]); });
        }
      },0);
    }

    function getVehicle(vin){
      const v=(vin||"").trim().toUpperCase();
      const d=VIN_DATA[v]; if(d && d.ymmt) return d.ymmt;
      const a=ACQUIRE_NOW.find(x=>x.vin===v); if(a) return a.ymmt;
      const s=STOP_BUYING_UNITS.find(x=>x.vin===v); return s? s.ymmt : "Unknown Vehicle";
    }
    function setModalHeader(title, vin){
      const v=(vin||"").trim().toUpperCase();
      modalTitle.textContent=title;
      modalSub.textContent=vin ? `VIN: ${v} • ${getVehicle(v)}` : "—";
    }
    function chip(label,value,tone){
      return `<div class="qchip ${tone||''}"><span class="qlabel">${label}</span><span class="qval">${value}</span></div>`;
    }
    function setQuickChips(html){ quickChips.innerHTML = html || ""; }

    function escapeHtml(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }


function shortSegmentLabel(s){
  const str = String(s||"").trim();
  if(!str) return "Segment";
  const parts = str.split(/\s+/);
  // Default: Year Make Model (keeps things segment-first vs VIN/trim-specific)
  // If model is two words (e.g., Grand Cherokee), this may under-capture — we'll improve once real data fields exist.
  return parts.slice(0,3).join(" ");
}
    function intakeFor(vin){
      const v=(vin||"").trim().toUpperCase();
      if(!CALL_INTAKE[v]) CALL_INTAKE[v]={sellerAsk:"",mileage:"",notes:""};
      return CALL_INTAKE[v];
    }
    function wireIntakeInputs(vin){
      const v=(vin||"").trim().toUpperCase(); const intake=intakeFor(v);
      const a=document.getElementById("intakeAsk"), m=document.getElementById("intakeMiles"), n=document.getElementById("intakeNotes");
      if(a) a.oninput=()=>{intake.sellerAsk=a.value; try{ if(modalTitle && modalTitle.textContent==='Acquisition Assist') updateAssistOutput(v, window.__assistDisciplineLine||''); }catch(e){} };
      if(m) m.oninput=()=>{intake.mileage=m.value;};
      if(n) n.oninput=()=>{intake.notes=n.value;};
    }

    function updateCOITile(){
      const total = COI_BREAKDOWN.reduce((acc,x)=> acc + (parseMoney(x.leakage)||0), 0);
      coiTileValue.textContent = fmtMoney(total);
    }

    
    function updateAssistOutput(vin, disciplineLineStr){
      const v=(vin||"").trim().toUpperCase();
      const intake=intakeFor(v);
      const ask=parseMoney(intake.sellerAsk);
      const dl=parseMoney(disciplineLineStr);
      const decEl=document.getElementById("assistDecision");
      const ctrEl=document.getElementById("assistCounter");
      if(!decEl || !ctrEl) return;
      if(Number.isNaN(ask) || !intake.sellerAsk){
        decEl.textContent="Enter a seller ask to generate an action.";
        ctrEl.textContent="";
        return;
      }
      if(Number.isNaN(dl)){
        decEl.textContent="No discipline line available for this VIN yet.";
        ctrEl.textContent="Run Analyze first to build memory, then re-open Acquisition Assist.";
        return;
      }
      const gap = ask - dl;
      if(gap <= 0){
        decEl.textContent="Proceed — within discipline.";
        ctrEl.textContent = `Seller ask is ${fmtMoney(Math.abs(gap))} under the discipline line. Confirm recon + condition, then buy tight.`;
      } else {
        decEl.textContent="Counter or walk — above discipline.";
        const counter = dl;
        ctrEl.textContent = `Seller is ${fmtMoney(gap)} above the discipline line. Recommended counter: ${fmtMoney(counter)}. If they won’t move, walk.`;
      }
    }

    function renderMemory(vin){
      const v=(vin||"").trim().toUpperCase();
      window.__activeVin = v;
      const d=VIN_DATA[v]||null;
      const guard=AUCTION_GUARDRAIL[v]||{status:"Within Guardrail",rationale:"Constraints appear aligned."};
      const peer=PEER_CONTEXT[v]||{label:"—",note:"Peer context becomes available as the dataset expands."};

      // Source Intelligence (used for the Source chip + right panel)
      const src = sourceForVin(v);
      const srcTone = (src.type === "service") ? "good" : (src.type === "service_upcoming" || src.type === "appraisal") ? "warn" : "bad";

      setModalHeader("Outcome Memory", v);

      const data=d||{ymmt:getVehicle(v),rec:"No Store History",confidence:"Low",buyTo:"—",walkAway:"—",owned:"0 units",front:"—",recon:"—",days:"—",
        loss:"No prior ownership in memory. Capture this interaction and Outcome gets smarter over time.",coi:"—",risk:"—",turn:"—",reconVar:"—"};

      let disciplineLine=data.buyTo, disciplineNote="Discipline line based on your store memory.";
      const baseBuy=parseMoney(data.buyTo), avgFront=parseMoney(data.front);
      if(!Number.isNaN(baseBuy) && !Number.isNaN(avgFront)){
        const delta=Math.max(0,grossGoal-avgFront);
        disciplineLine=fmtMoney(baseBuy-delta);
        disciplineNote=delta>0?`To target ${fmtMoney(grossGoal)}, tighten by ${fmtMoney(delta)} versus history.`:"Goal aligns with history. No tightening needed.";
      }

      // Make Acquisition Assist immediately usable after running Analyze.
      // (Assist reads this value to generate counters vs the discipline line.)
      window.__assistDisciplineLine = disciplineLine;

      const riskTone=String(data.risk).toLowerCase().includes("high")?"bad":(String(data.risk).toLowerCase().includes("medium")?"warn":"good");
      const turnTone=String(data.turn).toLowerCase().includes("slow")?"bad":(String(data.turn).toLowerCase().includes("medium")?"warn":"good");
      const reconTone=String(data.reconVar).toLowerCase().includes("high")?"bad":(String(data.reconVar).toLowerCase().includes("medium")?"warn":"good");
      const guardTone=String(guard.status).toLowerCase().includes("outside")?"bad":"good";

      setQuickChips(
        chip("Risk", data.risk || "—", riskTone) +
        chip("Turn", data.turn || "—", turnTone) +
        chip("Recon", data.reconVar || "—", reconTone) +
        chip("Guardrail", guard.status, guardTone) +
        chip("Peers", peer.label, "warn") +
        chip("Source", src.label || "—", srcTone)
      );

      leftTitle.textContent="Coverage Breakdown";
      leftIntro.textContent = d ? "Store history found. Outcome is summarizing how this profile behaves in your store."
                               : "No store history found. Outcome will capture this interaction and build memory over time.";

      // Governance one-liner (dealer language): shows a quick verdict + opens Governance modal.
      const govLine = buildGovSummaryLine(v);
      // Insert right under the intro text
      const introEl = document.getElementById('leftIntro');
      let govEl = document.getElementById('govSummaryLine');
      if(!govEl){
        govEl = document.createElement('div');
        govEl.id = 'govSummaryLine';
        govEl.className = 'govSummaryLine';
        introEl.insertAdjacentElement('afterend', govEl);
      }
      govEl.innerHTML = govLine;

      leftKv.innerHTML="";
  leftExtra.innerHTML =
        (d ? `<table class="table"><thead><tr><th>Owned</th><th>Avg Front</th><th>Avg Recon</th><th>Avg Days</th></tr></thead>
              <tbody><tr><td>${data.owned}</td><td>${data.front}</td><td>${data.recon}</td><td>${data.days}</td></tr></tbody></table>` : "") +
        `<div class="foot"><strong>Loss Insight:</strong> ${data.loss}</div>
         <div class="foot"><strong>Peer Context:</strong> ${peer.note}</div>
         <div class="foot"><strong>Auction Guardrail:</strong> ${guard.rationale}</div>`;
      leftBadge.textContent=`Memory Confidence: ${data.confidence}`; setBadge(leftBadge, data.confidence);
      // Right panel: COI Directional (context-specific)
      const ctx = (window.__memoryContext || 'memory').toLowerCase();
      const isAcquire = ctx==='acquire';
      const isStop = ctx==='stop';
      const title = 'COI Direction';
      const label = isAcquire ? 'Cost of Passing' : isStop ? 'Cost of Buying' : 'Cost of Inaction';
      // Dollars: Acquire uses VIN COI if present; Stop uses fixed preview unless dealer feeds provide coiStop
      const dollars = isAcquire
        ? ((data.coi && data.coi!=='—') ? data.coi : '$3,420')
        : isStop
          ? (()=>{
              // Stop Buying: always show VIN-specific downside (Cost of Buying)
              try{
                const cobNow = deriveVinCostOfBuying(data);
                return (isFinite(cobNow) && cobNow>0) ? fmtMoney(cobNow) :
                       ((data.coiStop && data.coiStop!=='—') ? data.coiStop : ((data.coi && data.coi!=='—') ? data.coi : '$4,180'));
              }catch(e){
                return ((data.coiStop && data.coiStop!=='—') ? data.coiStop : ((data.coi && data.coi!=='—') ? data.coi : '$4,180'));
              }
            })()
          : ((data.coi && data.coi!=='—') ? data.coi : '$8,635');

      if(isAcquire){
        // Keep sourcing visible at the top, then COI Direction below it
        rightBody.innerHTML = renderSourceRightPanel(v) + `
          <div style="height:1px; background:rgba(255,255,255,.08); margin:14px 0;"></div>
          <div class="coiHdr" style="margin-bottom:8px;">COST OF PASSING</div>
        ` + renderCOIRightPanel('acquire', dollars);
      } else if(isStop){
        rightBody.innerHTML = `<div class="coiHdr" style="margin-bottom:8px;">COST OF OWNING</div>` + renderCOIRightPanel('stop', dollars);
      } else {
        rightBody.innerHTML = `<div class="coiHdr" style="margin-bottom:8px;">COST OF INACTION</div>` + renderCOIRightPanel('coi', dollars);
      }

      setDial(data.confidence);

    }

    function renderAssist(vin){
      const v=(vin||"").trim().toUpperCase();
      const d=VIN_DATA[v]||null;
      const guard=AUCTION_GUARDRAIL[v]||{status:"Within Guardrail",rationale:"Constraints appear aligned."};
      const peer=PEER_CONTEXT[v]||{label:"—",note:"Peer context becomes available as the dataset expands."};

      setModalHeader("Acquisition Assist", v);

      const data=d||{confidence:"Low",buyTo:"—",walkAway:"—",rec:"—",front:"—",recon:"—",days:"—",risk:"—",turn:"—",reconVar:"—"};

      let disciplineLine=data.buyTo, delta=0;
      const baseBuy=parseMoney(data.buyTo), avgFront=parseMoney(data.front);
      if(!Number.isNaN(baseBuy) && !Number.isNaN(avgFront)){
        delta=Math.max(0,grossGoal-avgFront);
        disciplineLine=fmtMoney(baseBuy-delta);
      }

      const riskTone=String(data.risk).toLowerCase().includes("high")?"bad":(String(data.risk).toLowerCase().includes("medium")?"warn":"good");
      const turnTone=String(data.turn).toLowerCase().includes("slow")?"bad":(String(data.turn).toLowerCase().includes("medium")?"warn":"good");
      const reconTone=String(data.reconVar).toLowerCase().includes("high")?"bad":(String(data.reconVar).toLowerCase().includes("medium")?"warn":"good");
      const guardTone=String(guard.status).toLowerCase().includes("outside")?"bad":"good";

      setQuickChips(
        chip("Risk", data.risk || "—", riskTone) +
        chip("Turn", data.turn || "—", turnTone) +
        chip("Recon", data.reconVar || "—", reconTone) +
        chip("Guardrail", guard.status, guardTone) +
        chip("Peers", peer.label, "warn")
      );

      leftTitle.textContent="Coverage Breakdown";
      leftIntro.textContent="";
  leftBadge.textContent=`Confidence: ${data.confidence}`; setBadge(leftBadge, data.confidence);

      leftKv.innerHTML="";
  leftExtra.innerHTML = `
        <div class="foot"><strong>What Outcome knows about this unit:</strong></div>
        ${data.front !== "—" ? `<table class="table"><thead><tr><th>Owned</th><th>Avg Front</th><th>Avg Recon</th><th>Avg Days</th></tr></thead>
          <tbody><tr><td>${data.owned || "—"}</td><td>${data.front}</td><td>${data.recon}</td><td>${data.days}</td></tr></tbody></table>` : ""}
        <div class="foot"><strong>Guardrail:</strong> ${guard.rationale}</div>
        <div class="foot"><strong>Peer Context:</strong> ${peer.note}</div>
      `;

      const intake=intakeFor(v);
      rightTitle.textContent="Call Intake";
      rightBadge.textContent="Capture it";
      setBadge(rightBadge,"High");
      rightBody.innerHTML = `
        <div class="field"><label>Seller Ask</label><input id="intakeAsk" placeholder="Enter seller ask…" value="${escapeHtml(intake.sellerAsk)}" /></div>
        <div class="field"><label>Mileage</label><input id="intakeMiles" placeholder="Enter mileage…" value="${escapeHtml(intake.mileage)}" /></div>
        <div class="field"><label>Condition Notes</label><textarea id="intakeNotes" placeholder="Short bullets only…">${escapeHtml(intake.notes)}</textarea></div>
        <div class="minihelp"><strong>
      `;
      setTimeout(()=>wireIntakeInputs(v),0);
      setDial(data.confidence);
    }

    function renderAcquireNow(){
      setQuickChips("");
      try{ modal.querySelector('.sheet')?.classList.add('singlePane'); }catch(e){}
      modalTitle.textContent="Acquire Now"; modalSub.textContent="Best-fit opportunities";
      leftTitle.textContent="Coverage Breakdown"; leftBadge.textContent="Focus: Profit"; setBadge(leftBadge,"High");
      leftIntro.textContent="";
  
      const list = ACQUIRE_NOW.filter(x=>VIN_DATA[x.vin]);
      const b = (window.__storeBaselines||{});
      const baselineStrip = `
        <div class="proofStripHdr" aria-label="Store baseline proof strip">
          <span class="itag">Store median front: <b>${Number.isFinite(b.FG_med)?fmtMoney(Math.round(b.FG_med)):"—"}</b></span>
          <span class="itag">Store median days: <b>${Number.isFinite(b.DTS_med)?Math.round(b.DTS_med):"—"}</b></span>
          <span class="itag">Store median recon: <b>${Number.isFinite(b.Recon_med)?fmtMoney(Math.round(b.Recon_med)):"—"}</b></span>
        </div>
      `;
      const tone = (v, dir)=>{ // dir: "upGood" | "downGood"
        if(!Number.isFinite(v)) return "";
        if(dir==="upGood") return "good";
        if(dir==="downGood") return "good";
        return "";
      };
      const rows = list.map(x=>{
        const p = x.proof || {};
        const fg = Number.isFinite(p.fg_mean) ? fmtMoney(Math.round(p.fg_mean)) : "—";
        const dts = Number.isFinite(p.dts_med) ? Math.round(p.dts_med)+"d" : "—";
        const rc = Number.isFinite(p.rc_med) ? fmtMoney(Math.round(p.rc_med)) : "—";
        const confTone = (x.conf==="High") ? "good" : (x.conf==="Medium") ? "warn" : "";
        // Delta-tones (Acquire: higher front is good; lower days/recon is good)
        const fgTone = (Number.isFinite(p.fg_mean) && Number.isFinite(p.FG_med) && p.fg_mean >= p.FG_med) ? "good" : "warn";
        const dtsTone = (Number.isFinite(p.dts_med) && Number.isFinite(p.DTS_med) && p.dts_med <= p.DTS_med) ? "good" : "warn";
        const rcTone = (Number.isFinite(p.rc_med) && Number.isFinite(p.Recon_med) && p.rc_med <= p.Recon_med) ? "good" : "warn";
        return `
          <div class="segCard" data-memrow="1" data-vin="${x.vin}" data-ctx="acquire">
            <div class="segTop">
              <div style="display:flex; flex-direction:column;">
                <div class="segTitle">${escapeHtml((x.segmentLabel||x.segment||x.ymmt||"Segment"))}</div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:120px;">
                <span class="itag ${confTone}">Segment Confidence: <b>${escapeHtml(x.conf||"—")}</b></span>
                <div style="font-size:11px; color:rgba(215,224,236,.72); letter-spacing:.12em; text-transform:uppercase;">Buy-To</div>
                <div style="font-size:16px; font-weight:760; color:rgba(238,243,251,.95)">${escapeHtml(x.buyTo||"—")}</div>
              </div>
            </div>

            <div class="proofStrip" aria-label="Proof points">
              <span class="itag ${fgTone}">Front: <b>${fg}</b></span>
              <span class="itag ${dtsTone}">Days: <b>${dts}</b></span>
              <span class="itag ${rcTone}">Recon: <b>${rc}</b></span>
              <span class="itag">Owned: <b>${(x.owned||"—")}</b></span>
            </div>

            <div class="segWhy">${x.why || ""}</div>
          </div>
        `;
      }).join("");
      const rowsHtml = rows || '<div class="foot">No eligible Acquire Now segments yet — add more history to unlock repeatable patterns.</div>';
      leftKv.innerHTML="";
      leftExtra.innerHTML = `${baselineStrip}<div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">${rowsHtml}</div>`;
      rightTitle.textContent=''; rightBadge.textContent='';
      rightBody.innerHTML = ``;
      setTimeout(wireMemoryRowClicks, 0);
    }

    function renderStopBuying(){
      setQuickChips("");
      try{ modal.querySelector('.sheet')?.classList.add('singlePane'); }catch(e){}
      modalTitle.textContent="Stop Buying"; modalSub.textContent="Units that require perfect discipline";
      leftTitle.textContent="Coverage Breakdown"; leftBadge.textContent="Discipline Required"; setBadge(leftBadge,"Low");
      leftIntro.textContent="";
  
      const list = STOP_BUYING_UNITS.filter(x=>x && VIN_DATA && VIN_DATA[x.vin]);
      const b = (window.__storeBaselines||{});
      const baselineStrip = `
        <div class="proofStripHdr" aria-label="Store baseline proof strip">
          <span class="itag">Store median front: <b>${Number.isFinite(b.FG_med)?fmtMoney(Math.round(b.FG_med)):"—"}</b></span>
          <span class="itag">Store median days: <b>${Number.isFinite(b.DTS_med)?Math.round(b.DTS_med):"—"}</b></span>
          <span class="itag">Store median recon: <b>${Number.isFinite(b.Recon_med)?fmtMoney(Math.round(b.Recon_med)):"—"}</b></span>
        </div>
      `;
      const rows = list.map(x=>{
        const p = x.proof || {};
        const fg = Number.isFinite(p.fg_mean) ? fmtMoney(Math.round(p.fg_mean)) : "—";
        const dts = Number.isFinite(p.dts_med) ? Math.round(p.dts_med)+"d" : "—";
        const rc = Number.isFinite(p.rc_med) ? fmtMoney(Math.round(p.rc_med)) : "—";
        const fgTone = (Number.isFinite(p.fg_mean) && Number.isFinite(p.FG_med) && p.fg_mean <= p.FG_med) ? "bad" : "warn";
        const dtsTone = (Number.isFinite(p.dts_med) && Number.isFinite(p.DTS_med) && p.dts_med >= p.DTS_med) ? "bad" : "warn";
        const rcTone = (Number.isFinite(p.rc_med) && Number.isFinite(p.Recon_med) && p.rc_med >= p.Recon_med) ? "bad" : "warn";
        const tailTone = (Number.isFinite(p.pctOver60) && p.pctOver60 >= 0.25) ? "bad" : "warn";
        const tailTxt = Number.isFinite(p.pctOver60) ? Math.round(p.pctOver60*100)+'%' : '—';
        return `
          <div class="segCard" data-memrow="1" data-vin="${x.vin}" data-ctx="stop">
            <div class="segTop">
              <div style="display:flex; flex-direction:column;">
                <div class="segTitle">${escapeHtml((x.segmentLabel||x.segment||x.ymmt||"Segment"))}</div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:120px;">
                <span class="itag bad">${escapeHtml(x.flag||"High Risk Buy")}</span>
                <span class="itag warn">Discipline Required</span>
              </div>
            </div>

            <div class="proofStrip" aria-label="Proof points">
              <span class="itag ${fgTone}">Front: <b>${fg}</b></span>
              <span class="itag ${dtsTone}">Days: <b>${dts}</b></span>
              <span class="itag ${rcTone}">Recon: <b>${rc}</b></span>
              <span class="itag ${tailTone}">60+ day tail: <b>${tailTxt}</b></span>
            </div>

            <div class="segWhy"><b>Signal:</b> ${x.signal || "—"}</div>
            <div class="segWhy" style="margin-top:4px;"><b>Impact:</b> ${x.impact || "—"}</div>
            <div class="segWhy" style="margin-top:4px;"><b>Guidance:</b> ${x.guidance || "—"}</div>
          </div>
        `;
      }).join("");
      const rowsHtmlStop = rows || '<div class="foot">No Stop Buying segments yet — connect more store history to activate this list.</div>';
      leftKv.innerHTML="";
      leftExtra.innerHTML = `${baselineStrip}<div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">${rowsHtmlStop}</div>`;
      rightTitle.textContent=''; rightBadge.textContent='';
      rightBody.innerHTML = ``;
      setTimeout(wireMemoryRowClicks, 0);
    }

    

    function renderCOI(){
      const total = COI_TOTAL || 0;
      const totalFmt = fmtMoney(total);

      modalTitle.textContent = 'Cost of Inaction';
      modalSubtitle.textContent = 'Store total — leakage from doing nothing';
      leftTitle.textContent = 'COI Directional Preview';
      rightTitle.textContent = 'What to do next';

      // Keep labels clean: show dollars INSIDE the preview card (single source of truth)
      leftBadge.textContent = 'Cost of Doing Nothing';
      rightBadge.textContent = 'Action Plan';

      leftBody.innerHTML = renderCOIRightPanel('store', totalFmt);

      rightBody.innerHTML = ``;
      modal.classList.add('show');
    }

    function openRoadmap(){
      document.getElementById('roadList').innerHTML = UPGRADES_BACKLOG.map(x=>`<li style="margin:6px 0;">${x}</li>`).join("");
      roadmap.classList.add('open'); roadmap.setAttribute('aria-hidden','false');
    }
    function closeRoadmap(){ roadmap.classList.remove('open'); roadmap.setAttribute('aria-hidden','true'); }

    function openGross(){ grossInput.value=String(grossGoal); grossModal.classList.add('open'); grossModal.setAttribute('aria-hidden','false'); }
    function closeGross(){ grossModal.classList.remove('open'); grossModal.setAttribute('aria-hidden','true'); }
    function saveGross(){ grossGoal=Math.max(0, Number(grossInput.value||0)); grossGoalText.textContent=fmtMoney(grossGoal); closeGross(); }
    grossGoalText.textContent = fmtMoney(grossGoal);

    window.__drillMemory = (vin, ctx)=>{
      window.__memoryContext = ctx || 'memory';
      window.__CURRENT_VIN = (vin||'').trim().toUpperCase();
      navigate(renderMemory,[vin]);
    };

    // Initialize Data Readiness tile (demo coverage until real data is ingested)
    updateReadinessTile();

    btnAnalyze.addEventListener('click', ()=>{
    const vin = (vinInput?.value || '').trim();
    openVinSuperModal(vin || __demoVIN);
  });
    btnAssist.addEventListener('click', ()=>navigate(renderAssist,[vinInput.value]));
    document.getElementById('tileAcquire').addEventListener('click', ()=>navigate(renderAcquireNow,[]));
    document.getElementById('tileStop').addEventListener('click', ()=>navigate(renderStopBuying,[]));
    document.getElementById('tileCOI').addEventListener('click', ()=>navigate(renderCOI,[]));
    const readinessPill = document.getElementById('readinessPill');
    if(readinessPill){
      readinessPill.addEventListener('click', ()=>navigate(renderReadinessBreakdown,[]));
    }

    btnClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
    btnBack.addEventListener('click', goBack);

    grossPill.addEventListener('click', openGross);
    btnGrossClose.addEventListener('click', closeGross);
    btnGrossSave.addEventListener('click', saveGross);
    grossModal.addEventListener('click', (e)=>{ if(e.target===grossModal) closeGross(); });

    btnRoadClose.addEventListener('click', closeRoadmap);
    roadmap.addEventListener('click', (e)=>{ if(e.target===roadmap) closeRoadmap(); });

    vinInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') navigate(renderMemory,[vinInput.value]); });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ closeModal(); closeRoadmap(); closeGross(); }
      if(e.key==='?'){ openRoadmap(); }
    });

    
    function renderTicker(){
      const track = document.getElementById("insightTrack");
      if(!track) return;

      const pills = TOP_INSIGHTS.map((x, idx)=>`
        <div class="ipill" data-insight-idx="${idx}" role="button" tabindex="0" title="Click to expand">
          <span class="itag ${x.tone}">${x.tag}</span>
          <span>${x.text}</span>
        </div>
      `).join("");

      // Duplicate content so the CSS scroll can loop seamlessly.
      track.innerHTML = pills + pills;

      // Hard-wire interactions on the track itself (more reliable than document delegation).
      if(!track.__wired){
        track.__wired = true;
        track.addEventListener('click', (e)=>{
          const pill = e.target && e.target.closest ? e.target.closest('.ipill[data-insight-idx]') : null;
          if(!pill) return;
          const idx = Number(pill.getAttribute('data-insight-idx'));
          if(Number.isFinite(idx) && typeof window.__openInsight === 'function'){
            window.__openInsight(idx);
          }
        });
        track.addEventListener('keydown', (e)=>{
          if(e.key !== 'Enter' && e.key !== ' ') return;
          const pill = e.target && e.target.closest ? e.target.closest('.ipill[data-insight-idx]') : null;
          if(!pill) return;
          e.preventDefault();
          const idx = Number(pill.getAttribute('data-insight-idx'));
          if(Number.isFinite(idx) && typeof window.__openInsight === 'function'){
            window.__openInsight(idx);
          }
        });
      }
    }

    window.__openInsight = (idx)=>{
      const x = TOP_INSIGHTS[idx];
      if(!x) return;
      navigate(renderInsightDetail, [x]);
    };
    // Top Insights click delegation (avoids inline onclick issues)
    if(!window.__insightDelegationBound){
      window.__insightDelegationBound = true;
      document.addEventListener('click', (e)=>{
        const pill = e.target && e.target.closest ? e.target.closest('.ipill[data-insight-idx]') : null;
        if(!pill) return;
        const idx = Number(pill.getAttribute('data-insight-idx'));
        if(Number.isFinite(idx)) window.__openInsight(idx);
      });
      document.addEventListener('keydown', (e)=>{
        if(e.key !== 'Enter' && e.key !== ' ') return;
        const pill = e.target && e.target.closest ? e.target.closest('.ipill[data-insight-idx]') : null;
        if(!pill) return;
        e.preventDefault();
        const idx = Number(pill.getAttribute('data-insight-idx'));
        if(Number.isFinite(idx)) window.__openInsight(idx);
      });
    }


    function renderInsightDetail(x){
      modalTitle.textContent = "Insight";
      modalSub.textContent = x.tag;

      setQuickChips(chip("Type", x.tag, x.tone) + chip("Where to go", x.drill, "warn"));

      leftTitle.textContent="Coverage Breakdown";
      leftBadge.textContent = "Store-specific pattern";
      setBadge(leftBadge, "High");
      leftIntro.textContent = x.text;

      leftKv.innerHTML="";
  const drillMap = {
        "Acquire": { label:"Open Acquire Now", fn: ()=>navigate(renderAcquireNow, []) },
        "Stop": { label:"Open Stop Buying", fn: ()=>navigate(renderStopBuying, []) },
        "COI": { label:"Open Cost of Inaction", fn: ()=>navigate(renderCOI, []) },
        "Assist": { label:"Open Acquisition Assist", fn: ()=>navigate(renderAssist, [vinInput.value]) },
        "Memory": { label:"Open Outcome Memory", fn: ()=>navigate(renderMemory, [vinInput.value]) },
        "Gross": { label:"Adjust Gross Goal", fn: ()=>openGross() }
      };

      const d = drillMap[x.drill] || drillMap["Memory"];

      leftExtra.innerHTML = `
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <div class="btn primary" role="button" tabindex="0" onclick="window.__insightDrill()">
            <span class="ico">↳</span> ${d.label}
          </div>
        </div>
        <div class="foot">
          This is the “pain point as the way in”: Outcome shows you where profit leaks, then gives you the discipline line to stop it.
        </div>
      `;

      window.__insightDrill = ()=>{ d.fn(); };

      rightTitle.textContent=""; rightBadge.textContent="";
  rightBody.innerHTML=""; if(typeof rightCol!=="undefined" && rightCol) rightCol.style.display="none";
setDial("High");
    }


    (function init(){

// Build Acquire/Stop lists from VIN_DATA using locked thresholds (mutates arrays; no wiring changes)
try{
  if(typeof buildListsFromVinData === "function"){
    const lists = buildListsFromVinData();
    if(lists && Array.isArray(lists.acquire) && lists.acquire.length){
      ACQUIRE_NOW.splice(0, ACQUIRE_NOW.length, ...lists.acquire);
    }
    if(lists && Array.isArray(lists.stop) && lists.stop.length){
      STOP_BUYING_UNITS.splice(0, STOP_BUYING_UNITS.length, ...lists.stop);
    }
  }
}catch(e){
  // If anything goes wrong, fall back to demo lists so UI/wiring never breaks.
  console.warn("Decision list build failed; using demo lists.", e);
}      // Sync tile counts to the same eligibility rules used in the modals
      const acqEligible = (typeof ACQUIRE_NOW!=="undefined") ? ACQUIRE_NOW.filter(x=>x && VIN_DATA && VIN_DATA[x.vin]).length : 0;
      const stopEligible = (typeof STOP_BUYING_UNITS!=="undefined") ? STOP_BUYING_UNITS.filter(x=>x && VIN_DATA && VIN_DATA[x.vin]).length : 0;
      const acqTileVal = document.querySelector("#tileAcquire .v");
      if(acqTileVal) acqTileVal.textContent = String(acqEligible);

      const stopTileVal = document.querySelector("#tileStop .v");
      if(stopTileVal) stopTileVal.textContent = String(stopEligible);

      updateCOITile();
      renderTicker();
      const d = VIN_DATA[(vinInput.value||"").trim().toUpperCase()];
      setDial(d ? d.confidence : "Low");
      updateGovPillVisibility();
      vinInput.addEventListener('input', ()=>{
        const vin=(vinInput.value||"").trim().toUpperCase();
        const dd=VIN_DATA[vin];
        setDial(dd ? dd.confidence : "Low");
        updateGovPillVisibility();
      });
    })();
  
</script>

  <!-- COI Store Modal (separate, reliable open) -->
  <div class="modal" id="coiStoreModal" aria-hidden="true">
    <div class="sheet">
      <div class="modalTop">
        <div class="modalTitle">
          <div class="kicker">COST OF INACTION</div>
          <div class="sub">Store total — leakage from doing nothing</div>
        </div>
        <button class="btnGhost" data-close-coi>Close</button>
      </div>

      <div class="modalBody twoCol">
        <div class="panel">
          <div class="panelHdr">
            <div class="panelLabel">COMBINED LEAKAGE (THIS MONTH)</div>
            <span class="pill pill--coi" id="coiStorePill">Cost of Inaction: $0</span>
          </div>

          <div class="muted">This is the cost of NOT acting when Outcome tells you to. It includes missed buys and bad holds.</div>

          <div class="statGrid" style="margin-top:12px">
            <div class="stat">
              <div class="stat__k">TOTAL LEAKAGE</div>
              <div class="stat__v" id="coiStoreTotal">$0</div>
              <div class="stat__s">If you do nothing, this is what you leak.</div>
            </div>
            <div class="stat">
              <div class="stat__k">DECISION FIX</div>
              <div class="stat__v" style="font-size:16px">BUY / DON'T BUY</div>
              <div class="stat__s">Faster action + tighter discipline.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="coiCard">
            <div class="coiInsight">Here’s the leak: you’re leaking <span id="coiStoreLeakInline">$0</span> this month by ignoring clear actions.</div>
            <div class="coiMuted">Passing on winners + holding losers</div>

            <div class="coiMetaGrid">
              <div class="meta"><div class="metaK">LEAK TYPE</div><div class="metaV">Missed Buys</div></div>
              <div class="meta"><div class="metaK">LEAK TYPE</div><div class="metaV">Bad Holds</div></div>
              <div class="meta"><div class="metaK">DECISION FIX</div><div class="metaV">BUY / DON'T BUY</div></div>
              <div class="meta"><div class="metaK">OUTCOME FIX</div><div class="metaV">Act faster</div></div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="muted"><b>Dealer-simple:</b> You’re losing money two ways — by passing on good cars and keeping bad ones.</div>
        </div>

        <div class="panel">
          <div class="panelHdr">
            <div class="panelLabel">WHAT TO DO NEXT</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="pill pill--warn">Action Plan</span>
            </div>
          </div>

          <div class="muted">Turn leakage into actions. These buttons jump you straight into the workflows.</div>

          <div class="actionRow">
            <button class="actionBtn actionBtn--primary" data-open-acquire>Open Acquire Now</button>
            <button class="actionBtn actionBtn--primary" data-open-stop>Open Stop Buying</button>
            <button class="actionBtn actionBtn--warn" data-open-buydecision>Open Buy Decision</button>
          </div>

          <div class="divider"></div>

          <div class="muted">
            Dealer-simple: You’re losing money two ways — passing on winners and holding losers. Fix is faster decisions.
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- VIN SUPER MODAL (One VIN = One Screen) -->
  <div id="vinSuperModal" class="omodal" aria-hidden="true">
    <div class="omodal__sheet">
      <div class="omodal__top">
        <button class="btn--ghost" data-close-super>← Back</button>
        <div class="omodal__title">
          <div class="kicker">VIN INTELLIGENCE</div>
          <div class="headline">
            <span class="mono">VIN:</span> <span id="sv_vin" class="mono">—</span>
            <span class="dotSep">•</span>
            <span id="sv_title">—</span>
          </div>
        </div>
        <button class="btn--ghost" data-close-super>Close</button>
      </div>

      <div class="superGrid">
        <!-- 1) OUTCOME MEMORY -->
        <section class="pane" id="sv_memPane">
          <!-- filled by JS -->
        </section>

        <!-- 2) BUY DECISION -->
        <section class="pane" id="sv_bdPane">
          <!-- filled by JS -->
        </section>

        <!-- 3) SOURCING + COI -->
        <section class="pane" id="sv_rightPane">
          <!-- filled by JS -->
        </section>
      </div>
    </div>
  </div>


<!-- Hidden Admin: ROI Tuning (Ctrl+Alt+O or click title 5x) -->
<div id="adminOverlay" class="overlay" style="display:none; z-index:99999;">
  <div class="modalShell" style="max-width:860px;">
    <div class="modalHeader">
      <div>
        <div class="modalTitle">ROI Tuning (Hidden)</div>
        <div class="modalSub">Adjust defaults used by Buy-To / Cost math. Saved locally in this browser.</div>
      </div>
      <button class="btn ghost" id="adminCloseBtn">Close</button>
    </div>
    <div class="modalBody" style="padding:16px 18px 18px;">
      <div class="grid3" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
        <div class="card" style="padding:14px;">
          <div class="kicker">Daily carry cost</div>
          <div class="subtle" style="margin-top:4px;">$/day used for carry downside math</div>
          <input id="setDailyCarry" type="number" step="1" min="0" class="input" style="margin-top:10px; width:100%;" />
        </div>
        <div class="card" style="padding:14px;">
          <div class="kicker">Target days</div>
          <div class="subtle" style="margin-top:4px;">Days threshold before carry penalty</div>
          <input id="setTargetDays" type="number" step="1" min="0" class="input" style="margin-top:10px; width:100%;" />
        </div>
        <div class="card" style="padding:14px;">
          <div class="kicker">Min profit (High)</div>
          <div class="subtle" style="margin-top:4px;">$ floor in Buy-To math (High band)</div>
          <input id="setMinProfitHigh" type="number" step="50" min="0" class="input" style="margin-top:10px; width:100%;" />
        </div>
        <div class="card" style="padding:14px;">
          <div class="kicker">Min profit (Medium)</div>
          <div class="subtle" style="margin-top:4px;">$ floor in Buy-To math (Medium band)</div>
          <input id="setMinProfitMed" type="number" step="50" min="0" class="input" style="margin-top:10px; width:100%;" />
        </div>
        <div class="card" style="padding:14px;">
          <div class="kicker">Min profit (Limited)</div>
          <div class="subtle" style="margin-top:4px;">$ floor in Buy-To math (Limited band)</div>
          <input id="setMinProfitLim" type="number" step="50" min="0" class="input" style="margin-top:10px; width:100%;" />
        </div>
        <div class="card" style="padding:14px;">
          <div class="kicker">Actions</div>
          <div class="subtle" style="margin-top:4px;">Applies immediately to UI</div>
          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn" id="adminSaveBtn">Save + Apply</button>
            <button class="btn ghost" id="adminResetBtn">Reset defaults</button>
            <a class="btn ghost" id="adminSpecLink" href="outcome_metrics_spec.pdf" target="_blank" rel="noopener">Open Metrics PDF</a>
          </div>
          <div class="subtle" style="margin-top:10px;">Tip: this is hidden from dealers. Shortcut: <b>Ctrl+Alt+O</b></div>
        </div>
      </div>

      <div class="divider" style="margin:16px 0;"></div>
      <div class="subtle">These settings drive: carry penalties, profit floors, and VIN downside/COI demo values. When real data lands, the same knobs will tune the exact formulas without changing any modals.</div>
    </div>
  </div>
</div>

</body>

<script>
(function(){
  const $ = (sel,root=document)=>root.querySelector(sel);
  const coiModal = $('#coiStoreModal');
  const tileCOI = $('#tileCOI');
  const coiTileValue = $('#coiTileValue');

  if(!coiModal || !tileCOI) return;

  function openCOIStore(){
    // COI Store modal uses the same .modal.open mechanics as other modals (not aria-hidden display toggling)
    if(!coiModal) return;
    coiModal.classList.add('open');
    coiModal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }
  function closeCOIStore(){
    if(!coiModal) return;
    coiModal.classList.remove('open');
    coiModal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  // Guaranteed open even if main modal renderCOI has issues
  // COI is a dashboard status strip (non-clickable)
  // tileCOI click-to-open disabled
  // tileCOI.addEventListener('click', function(e){
  //   e.preventDefault();
  //   e.stopPropagation();
  //   openCOIStore();
  // }, true);

  document.addEventListener('click', (e)=>{
    if(e.target && e.target.matches('[data-close-coi]')) closeCOIStore();
    if(e.target === coiModal) closeCOIStore();
  });

  // expose COI controls for cross-modal actions
  window.__openCOIStore = openCOIStore;
  window.__closeCOIStore = closeCOIStore;
})();

    // ===== VIN SUPER MODAL wiring =====
    (function(){
      const superModal = document.getElementById('vinSuperModal');
      const setText = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = (val==null||val==='') ? '—' : String(val); };

      function openVinSuperModal(vin, ctx){
        const v = (vin||'').trim().toUpperCase();
        if(!v) return;
        window.__activeVin = v;
        window.__memoryContext = (ctx||'memory').toLowerCase();

        // header
        setText('sv_vin', v);
        const meta = VIN_DATA[v] || {};
        setText('sv_title', meta.ymmt || getVehicle(v) || 'Vehicle');

        // build panes
        const memPane = document.getElementById('sv_memPane');
        const bdPane = document.getElementById('sv_bdPane');
        const rightPane = document.getElementById('sv_rightPane');
        if(memPane) memPane.innerHTML = buildOutcomeMemoryPane(v);
        if(bdPane) bdPane.innerHTML = buildBuyDecisionPane(v);
        if(rightPane) rightPane.innerHTML = buildRightPane(v, window.__memoryContext);

        // show
        if(superModal) superModal.setAttribute('aria-hidden','false');
      }

      function closeVinSuperModal(){
        if(superModal) superModal.setAttribute('aria-hidden','true');
      }

      // close controls
      document.addEventListener('click', (e)=>{
        if(e.target && e.target.matches && e.target.matches('[data-close-super]')) closeVinSuperModal();
        if(superModal && e.target === superModal) closeVinSuperModal();
      });

      // Replace drill behavior from Acquire/Stop vehicle rows
      window.__drillMemory = function(vin, ctx){
        openVinSuperModal(vin, ctx);
      };

      // expose
      window.openVinSuperModal = openVinSuperModal;
      window.closeVinSuperModal = closeVinSuperModal;

      // Builders
      function buildOutcomeMemoryPane(v){
        const d = VIN_DATA[v] || { ymmt:getVehicle(v), rec:'—', confidence:'Low', buyTo:'—', owned:'0 units', front:'—', recon:'—', days:'—', loss:'—', coi:'—', risk:'—', turn:'—', reconVar:'—' };

// VIN Confidence = action strength (Buy Decision %) for this VIN/profile.
// Segment Signal (if present) = reliability of the segment pattern that surfaced it.
const bdForVin = (()=>{ try{ return buyDecisionFromRisk(d.risk); }catch(e){ return {conf:0,label:'',why:''}; } })();
const vinPct = Number(bdForVin.conf || 0);
const vinBand = (vinPct>=75) ? 'High' : (vinPct>=60) ? 'Medium' : 'Limited';
const vinTone = (vinBand==='High') ? 'pill--good' : (vinBand==='Medium') ? 'pill--warn' : 'pill--bad';
// Prefer segment-level confidence when coming from Acquire/Stop segment cards
const segBandRaw = (window.__activeSegmentConf || '').toString().toLowerCase();
const segBand = segBandRaw ? (segBandRaw.charAt(0).toUpperCase() + segBandRaw.slice(1)) : '';
        const peer = PEER_CONTEXT[v] || {label:'—', note:'Peer context becomes available as the dataset expands.'};
        const src = sourceForVin(v);
        const srcLabel = src.label || '—';

        // Guardrail text (simple demo logic)
        const guard = (d.buyTo && d.buyTo!=='—') ? 'Within Guardrail' : 'No Guardrail';
        const sig = signalBandForVin(v);
        const memConf = segBand || sig.band;
        const limited = (memConf==='Limited') ? limitedSignalBanner(sig) : '';

        return `
          <div class="pane__hdr">
            <div class="pane__label">OUTCOME MEMORY</div>
            <span class=\"pill ${vinTone}\">VIN Confidence: ${vinBand}</span>${segBand?` <span class=\"pill ${memConf==='High'?'pill--good':(memConf==='Medium'?'pill--warn':(memConf==='Limited'?'pill--bad':'pill--warn'))}\" style=\"margin-left:8px;\">Segment Signal: ${memConf}</span>`:''}
          </div>

          ${limited}

          <div class="chipGrid">
            <div class="chip"><div class="chip__k">RISK</div><div class="chip__v">${d.risk||'—'}</div></div>
            <div class="chip"><div class="chip__k">TURN</div><div class="chip__v">${d.turn||'—'}</div></div>
            <div class="chip"><div class="chip__k">RECON</div><div class="chip__v">${d.reconVar||'—'}</div></div>
            <div class="chip"><div class="chip__k">GUARDRAIL</div><div class="chip__v">${guard}</div></div>
            <div class="chip"><div class="chip__k">PEERS</div><div class="chip__v">${peer.label||'—'}</div></div>
            <div class="chip"><div class="chip__k">SOURCE</div><div class="chip__v">${srcLabel}</div></div>
          </div>

          <div class="muted">${d.rec || 'Store history found. Outcome is summarizing how this profile behaves in your store.'}</div>

          <div class="statGrid">
            <div class="stat"><div class="stat__k">OWNED</div><div class="stat__v">${d.owned||'—'}</div><div class="stat__s">How many times your store has owned this profile.</div></div>
            <div class="stat"><div class="stat__k">AVG FRONT</div><div class="stat__v">${d.front||'—'}</div><div class="stat__s">Your store’s average front gross when you retail it.</div></div>
            <div class="stat"><div class="stat__k">AVG RECON</div><div class="stat__v">${d.recon||'—'}</div><div class="stat__s">Typical recon spend for this profile.</div></div>
            <div class="stat"><div class="stat__k">AVG DAYS</div><div class="stat__v">${d.days||'—'}</div><div class="stat__s">How long it usually takes to sell.</div></div>
          </div>

          <div class="divider"></div>
          <div class="muted"><b>Loss Insight:</b> ${d.loss||'—'}</div>
          <div class="muted" style="margin-top:8px;"><b>Peer Context:</b> ${peer.note||'—'}</div>
          <div class="muted" style="margin-top:8px;"><b>Auction Guardrail:</b> Discipline line: ${d.buyTo||'—'}</div>
        `;
      }

      function buyDecisionFromRisk(risk){
        const r = String(risk||'').toLowerCase();
        if(r==='low') return {label:'BUY THIS', tone:'good', conf:78, why:'Known winner profile. Cash comes back fast.'};
        if(r==='medium') return {label:'BUY TIGHT', tone:'warn', conf:62, why:'Viable if bought inside line and recon stays in check.'};
        return {label:"DON'T BUY", tone:'bad', conf:44, why:'Pattern risk is high. Tight margin + recon variance.'};
      }

      function buildBuyDecisionPane(v){
        const d = VIN_DATA[v] || {};
        const bd = buyDecisionFromRisk(d.risk);
        const pct = Number(bd.conf||0);
        const tone = (pct>=75) ? 'good' : (pct>=60) ? 'warn' : 'bad';
        const buyTo = d.buyTo || '—';
        const walk = d.walkAway || '—';

        return `
          <div class="pane__hdr">
            <div class="pane__label">BUY DECISION</div>
          </div>

          <div class="bdHero">
            <div class="bdScore ${tone}">
              <div class="bdPct">${pct}%</div>
              <div class="bdLbl">Buy Decision</div>
            </div>
            <div class="bdLine">
              <div class="k">BUY-TO</div>
              <div class="v">${buyTo}</div>
              <div class="s">Discipline line from store patterns. Walk-away: <b>${walk}</b></div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px;"><b>Outcome Says:</b> ${bd.label}</div>
          <div class="muted" style="margin-top:8px;">${bd.why}</div>

          <div class="divider"></div>
          <div class="pane__label" style="margin-bottom:8px;">WHAT'S DRIVING THIS VIN DECISION</div>
          <div class="muted">• How fast cars like this sell: <b>${d.turn||'—'}</b></div>
          <div class="muted">• How tight the margin gets: <b>${d.front||'—'}</b> avg front</div>
          <div class="muted">• Whether recon comes back: <b>${d.reconVar||'—'}</b></div>
          <div class="muted">• How often this store gets hurt: <b>${d.risk||'—'}</b> risk</div>

          <div class="divider"></div>
          <div class="muted"><b>What usually happens next:</b> ${d.loss || 'Outcome tracks what happens next as you transact more of these.'}</div>
        `;
      }

      function buildSourcingCards(v){
        const src = sourceForVin(v);
        // Support multiple types
        const cards = [];
        const add = (k,val)=>{ if(val==null||val==='') return; cards.push({k,val}); };
        add('CUSTOMER', src.customerLast || src.customer || '—');
        add('STATUS', src.status || '—');

        if(src.type==='service'){
          add('LAST SERVICE', src.lastService || src.when || '—');
          add('RO #', src.ro || '—');
          add('RO CLOSE DATE', src.roClose || '—');
          add('SERVICE TYPE', src.serviceType || '—');
        } else if(src.type==='service_upcoming'){
          add('NEXT APPT', src.nextAppt || '—');
          add('APPT ID', src.apptId || '—');
          add('SERVICE TYPE', src.serviceType || '—');
          add('REACQUIRE ANGLE', src.angle || '—');
        } else if(src.type==='appraisal'){
          add('LAST TOUCH', src.lastTouch || '—');
          add('APPRAISAL ID', src.appraisalId || '—');
          add('SOURCE TYPE', src.sourceType || '—');
          add('REACQUIRE ANGLE', src.angle || '—');
        } else {
          add('DETAIL', src.detail || '—');
        }

        const grid = cards.map(c=>`<div class="srcCard"><div class="srcK">${c.k}</div><div class="srcV">${c.val}</div></div>`).join('');
        return `<div class="srcGrid">${grid}</div>`;
      }

      function parseMoneySafe(x){
        if(typeof x === 'number') return x;
        const s = String(x||'').replace(/[^0-9.-]/g,'');
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }

      function buildCOIPreview(ctx, dollars){
        const label = ctx==='acquire' ? 'COST OF PASSING' : ctx==='stop' ? 'COST OF BUYING' : 'COST OF DOING NOTHING';
        const dir = ctx==='acquire' ? 'NOT BUYING' : ctx==='stop' ? 'KEEPING / BUYING' : 'DOING NOTHING';
        const primary = ctx==='acquire' ? 'Demand window' : ctx==='stop' ? 'Aging compression' : 'Decision lag';
        const shows = ctx==='acquire' ? 'Missed gross' : ctx==='stop' ? 'Capital drag' : 'Leakage compounds';
        const timing = ctx==='acquire' ? '7–14 days' : ctx==='stop' ? '14–30 days' : 'This month';

        const moneyStr = (typeof dollars === 'string' && dollars.trim()) ? dollars : (Number.isFinite(dollars) ? fmtMoney(dollars) : '$—');

        return `
          <div class="pane__hdr">
            <div class="pane__label">${label}</div>
            <span class="pill pill--coi">Cost of Inaction: ${moneyStr}</span>
          </div>

          <div class="coiCard">
            <div class="coiInsight">You lose <b>${moneyStr}</b> by ${ctx==='acquire' ? 'not buying this vehicle while demand is hot' : ctx==='stop' ? 'owning this profile when it drags performance' : 'doing nothing while leakage stacks up'}.</div>
            <div class="coiMuted">${ctx==='acquire' ? 'Missed front gross + missed velocity window + missed share' : ctx==='stop' ? 'Aging compression + recon variance + capital drag' : 'Missed buys + bad holds + slow decisions'}</div>

            <div class="coiMetaGrid">
              <div class="meta"><div class="metaK">COI DIRECTION</div><div class="metaV">${dir}</div></div>
              <div class="meta"><div class="metaK">PRIMARY DRIVER</div><div class="metaV">${primary}</div></div>
              <div class="meta"><div class="metaK">HOW IT SHOWS UP</div><div class="metaV">${shows}</div></div>
              <div class="meta"><div class="metaK">TIMING</div><div class="metaV">${timing}</div></div>
            </div>
          </div>
        `;
      }

      function buildRightPane(v, ctx){
        const d = VIN_DATA[v] || {};
        const isAcquire = ctx==='acquire';
        const isStop = ctx==='stop';

        // dollars per context
        const dollars = isAcquire ? (d.coi && d.coi!=='—' ? d.coi : '$3,420')
                      : isStop ? (d.coiStop && d.coiStop!=='—' ? d.coiStop : '$4,180')
                      : (d.coi && d.coi!=='—' ? d.coi : '$8,635');

        if(isAcquire){
          return `
            <div class="pane__hdr">
              <div class="pane__label">SOURCING</div>
              <span class="pill pill--src">${(sourceForVin(v).label)||'—'}</span>
            </div>
            ${buildSourcingCards(v)}
            <div class="divider"></div>
            ${buildCOIPreview('acquire', dollars)}
          `;
        }
        if(isStop){
          const stopDollars = (()=>{
            try{
              const n = deriveVinCostOfBuying(d||{});
              return (Number.isFinite(n) && n>0) ? fmtMoney(n) : dollars;
            }catch(e){
              return dollars;
            }
          })();
          return `
            ${buildCOIPreview('stop', stopDollars)}
            <div style="margin-top:8px;font-size:12px;color:rgba(215,224,236,.7);font-family:var(--mono);">VIN: ${escapeHtml(v||'—')}</div>
          `;
        }
        return `
          ${buildCOIPreview('coi', dollars)}
        `;
      }
    
    // COI modal (action-driven) buttons
    // Important: these buttons live inside the COI Store modal (#coiStoreModal).
    // We must close COI first, then open the destination modal, otherwise it appears "behind" COI.
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(!t || !t.matches) return;

      const closeCOI = ()=>{
        try{ window.__closeCOIStore && window.__closeCOIStore(); }catch(err){}
      };
      const openAfterClose = (fn)=>{
        // Close immediately, then open on the next frame so stacking/z-index never happens.
        closeCOI();
        requestAnimationFrame(()=>{ setTimeout(()=>{ try{ fn && fn(); }catch(err){} }, 30); });
      };

      if(t.matches('[data-open-acquire]')){
        e.preventDefault(); e.stopPropagation();
        openAfterClose(()=>{ try{ navigate(renderAcquireNow); }catch(err){} });
      }
      if(t.matches('[data-open-stop]')){
        e.preventDefault(); e.stopPropagation();
        openAfterClose(()=>{ try{ navigate(renderStopBuying); }catch(err){} });
      }
      if(t.matches('[data-open-buydecision]')){
        e.preventDefault(); e.stopPropagation();
        openAfterClose(()=>{ try{ window.openVinSuperModal && window.openVinSuperModal(window.__activeVin || Object.keys(VIN_DATA||{})[0] || '', 'memory'); }catch(err){} });
      }
    });
})();


/* ---------------------------
   Hidden Admin ROI Tuning
   - Ctrl+Alt+O or 5x click on title area
   - saves to localStorage
   - applies to demo-derived COI/carry/profit floors
---------------------------- */
const ROI_DEFAULTS = {
  dailyCarryCost: 45,
  targetDays: 21,
  minProfitHigh: 1200,
  minProfitMed: 1500,
  minProfitLim: 1800
};

function loadRoiSettings(){
  try{
    const raw = localStorage.getItem("outcome_roi_defaults_v1");
    if(!raw) return {...ROI_DEFAULTS};
    const obj = JSON.parse(raw);
    return {
      dailyCarryCost: clampNum(obj.dailyCarryCost, 0, 5000, ROI_DEFAULTS.dailyCarryCost),
      targetDays: clampNum(obj.targetDays, 0, 365, ROI_DEFAULTS.targetDays),
      minProfitHigh: clampNum(obj.minProfitHigh, 0, 20000, ROI_DEFAULTS.minProfitHigh),
      minProfitMed: clampNum(obj.minProfitMed, 0, 20000, ROI_DEFAULTS.minProfitMed),
      minProfitLim: clampNum(obj.minProfitLim, 0, 20000, ROI_DEFAULTS.minProfitLim),
    };
  }catch(e){
    return {...ROI_DEFAULTS};
  }
}
function saveRoiSettings(s){
  try{ localStorage.setItem("outcome_roi_defaults_v1", JSON.stringify(s)); }catch(e){}
}
function clampNum(v, lo, hi, fallback){
  const n = Number(v);
  if(!Number.isFinite(n)) return fallback;
  return Math.min(hi, Math.max(lo, n));
}

window.__ROI = loadRoiSettings();

// --- Apply to demo values (safe, non-wiring) ---
function deriveVinCostOfBuying(v){
  // VIN-specific downside model (demo + production-ready structure).
  // Important: self-contained parsing (does NOT rely on any modal-scoped helpers).
  const roi = (window.__ROI && typeof window.__ROI === 'object') ? window.__ROI : ROI_DEFAULTS;

  const num = (x)=>{
    if(typeof x === 'number') return x;
    const s = String(x||'').replace(/[^0-9.-]/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const intNum = (x)=>{
    const n = num(x);
    return Number.isFinite(n) ? Math.round(n) : 0;
  };

  const targetDays = Number.isFinite(Number(roi.targetDays)) ? Number(roi.targetDays) : ROI_DEFAULTS.targetDays;
  const dailyCarry = Number.isFinite(Number(roi.dailyCarryCost)) ? Number(roi.dailyCarryCost) : ROI_DEFAULTS.dailyCarryCost;
  const minHigh = Number.isFinite(Number(roi.minProfitHigh)) ? Number(roi.minProfitHigh) : ROI_DEFAULTS.minProfitHigh;
  const minMed  = Number.isFinite(Number(roi.minProfitMed))  ? Number(roi.minProfitMed)  : ROI_DEFAULTS.minProfitMed;
  const minLim  = Number.isFinite(Number(roi.minProfitLim))  ? Number(roi.minProfitLim)  : ROI_DEFAULTS.minProfitLim;

  const days = intNum(v?.days);
  const carry = Math.max(0, (days - targetDays)) * dailyCarry;

  const front = num(v?.front);
  const recon = num(v?.recon);

  const conf = String(v?.confidence||'').toLowerCase();
  const minProfit = (conf==='high') ? minHigh : (conf==='medium') ? minMed : minLim;

  const profitShort = Math.max(0, minProfit - front);
  const reconOver = Math.max(0, recon - 1500); // proxy until store baselines land

  const base = carry + profitShort + reconOver;
  const n = Number(base);
  if(!Number.isFinite(n)) return 0;
  return Math.round(n/5)*5;
}

function applyRoiToVinData(){
  if(typeof VIN_DATA!=="object") return;

  Object.keys(VIN_DATA).forEach(vin=>{
    const d = VIN_DATA[vin];
    if(!d) return;
    const cob = deriveVinCostOfBuying(d);

    // Stop Buying wants "Cost of Buying", Acquire wants "Cost of Passing".
    // For demo we keep the label "Cost of Inaction" but set the number via tuned downside.
    // NOTE: this does NOT change any modal wiring.
    const rec = String(d.rec||"");
    if(rec.toLowerCase().includes("risk") || rec.toLowerCase().includes("stop") || rec.toLowerCase().includes("caution")){
      d.coi = fmtMoney(cob);
      // also populate stop-specific field used in VIN Intelligence right column
      d.coiStop = d.coi;
    }else{
      // cost of passing proxy: upside missed (half of downside + speed bonus)
      const speedBonus = Math.max(0, (window.__ROI.targetDays - parseNum(d.days))) * window.__ROI.dailyCarryCost;
      d.coi = fmtMoney(Math.max(0, Math.round((cob*0.55 + speedBonus)/5)*5));
    }
  });
}

// Re-render helpers: rerun tiles + insights without touching modal handlers.
function reRenderAll(){
  try{
    applyRoiToVinData();
    // rebuild acquire/stop lists (counts/ordering)
    const recs = (typeof buildSegmentRecommendations==='function') ? buildSegmentRecommendations() : {acquire: (window.__ACQUIRE||[]), stop:(window.__STOP||[])};
    window.__ACQUIRE = recs.acquire;
    window.__STOP = recs.stop;
    if(typeof renderAcquireStopTiles==='function') renderAcquireStopTiles();
    if(typeof renderAcquireModal==='function') renderAcquireModal();
    if(typeof renderStopModal==='function') renderStopModal();
    // If VIN view is open, re-render it using currentVin if available
    if(window.__CURRENT_VIN){
      if(typeof openVinIntelligence==='function') openVinIntelligence(window.__CURRENT_VIN, window.__CURRENT_CONTEXT || 'Acquire');
    }
  }catch(e){
    console.warn("ROI apply failed:", e);
  }
}

// ---- Admin UI wiring ----
const adminOverlay = document.getElementById("adminOverlay");
const adminCloseBtn = document.getElementById("adminCloseBtn");
const adminSaveBtn = document.getElementById("adminSaveBtn");
const adminResetBtn = document.getElementById("adminResetBtn");

function openAdmin(){
  if(!adminOverlay) return;
  adminOverlay.style.display = "flex";
  // fill inputs
  document.getElementById("setDailyCarry").value = window.__ROI.dailyCarryCost;
  document.getElementById("setTargetDays").value = window.__ROI.targetDays;
  document.getElementById("setMinProfitHigh").value = window.__ROI.minProfitHigh;
  document.getElementById("setMinProfitMed").value = window.__ROI.minProfitMed;
  document.getElementById("setMinProfitLim").value = window.__ROI.minProfitLim;
}
function closeAdmin(){
  if(!adminOverlay) return;
  adminOverlay.style.display = "none";
}

if(adminCloseBtn) adminCloseBtn.addEventListener("click", closeAdmin);
if(adminOverlay) adminOverlay.addEventListener("click", (e)=>{ if(e.target===adminOverlay) closeAdmin(); });

if(adminSaveBtn) adminSaveBtn.addEventListener("click", ()=>{
  const next = {
    dailyCarryCost: clampNum(document.getElementById("setDailyCarry").value, 0, 5000, ROI_DEFAULTS.dailyCarryCost),
    targetDays: clampNum(document.getElementById("setTargetDays").value, 0, 365, ROI_DEFAULTS.targetDays),
    minProfitHigh: clampNum(document.getElementById("setMinProfitHigh").value, 0, 20000, ROI_DEFAULTS.minProfitHigh),
    minProfitMed: clampNum(document.getElementById("setMinProfitMed").value, 0, 20000, ROI_DEFAULTS.minProfitMed),
    minProfitLim: clampNum(document.getElementById("setMinProfitLim").value, 0, 20000, ROI_DEFAULTS.minProfitLim),
  };
  window.__ROI = next;
  saveRoiSettings(next);
  closeAdmin();
  reRenderAll();
});

if(adminResetBtn) adminResetBtn.addEventListener("click", ()=>{
  window.__ROI = {...ROI_DEFAULTS};
  saveRoiSettings(window.__ROI);
  reRenderAll();
  closeAdmin();
});

document.addEventListener("keydown", (e)=>{
  const isO = (e.key==="o" || e.key==="O");
  // Windows/Linux: Ctrl+Alt+O
  const winCombo = e.ctrlKey && e.altKey && isO;
  // macOS: Cmd+Shift+O OR Cmd+Option(Alt)+O
  const macCombo = e.metaKey && (e.shiftKey || e.altKey) && isO;

  if(winCombo || macCombo){
    e.preventDefault();
    openAdmin();
  }
});

// 5x click on the top title area to open admin (backup)
let __adminClicks = 0;
let __adminClickTimer = null;
const titleTapTarget = document.querySelector(".top h1, .headerTitle, #brandTitle, .brandTitle, header h1");
if(titleTapTarget){
  titleTapTarget.style.cursor = "default";
  titleTapTarget.addEventListener("click", ()=>{
    __adminClicks++;
    clearTimeout(__adminClickTimer);
    __adminClickTimer = setTimeout(()=>{ __adminClicks=0; }, 1100);
    if(__adminClicks>=5){
      __adminClicks=0;
      openAdmin();
    }
  });
}

// Initial apply
applyRoiToVinData();

</script>

</html>